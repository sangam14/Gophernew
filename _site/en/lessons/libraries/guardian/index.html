<!DOCTYPE HTML>



<html lang="en">
	<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta name="description" content="The premier destination for learning and mastering Elixir">
  <meta name="author" content="Sean Callan">

  <meta property="og:url" content="http://localhost:4000/en/lessons/libraries/guardian/">
  <meta property="og:site_name" content="ElixirSchool">
  <meta property="og:title" content="Elixir School">
  <meta property="og:locale" content="en">
  <meta property="og:description" content="The premier destination for learning and mastering Elixir">
  <meta property="og:image" content="http://localhost:4000/assets/og_image-fad975b316dea5dc361d199bdfaa076006da49a0a3296f799aa7217b4c8b0cbe.jpg">
  
  
    
    
    
    
      <link rel="alternate" hreflang="en" href="/en/lessons/libraries/guardian/" />
      <link rel="alternate" hreflang="x-default" href="/en/lessons/libraries/guardian/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="es" href="/es/lessons/libraries/guardian/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="el" href="/gr/lessons/libraries/guardian/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="ja" href="/ja/lessons/libraries/guardian/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="ko" href="/ko/lessons/libraries/guardian/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="pl" href="/pl/lessons/libraries/guardian/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="pt" href="/pt/lessons/libraries/guardian/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="ru" href="/ru/lessons/libraries/guardian/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="vi" href="/vi/lessons/libraries/guardian/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="zh-hans" href="/zh-hans/lessons/libraries/guardian/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="zh-hant" href="/zh-hant/lessons/libraries/guardian/" />
    
  

  <link rel="canonical" href="http://localhost:4000/en/lessons/libraries/guardian/">
  <link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/assets/favicons/apple-touch-icon-06ad80501b5734bba0428ca0fc14fcbe45811a144914f7be78cdab3c3ea25458.png">
  <link rel="icon" type="image/png" sizes="32x32" href="http://localhost:4000/assets/favicons/favicon-32x32-6e7b9eca57d29d185a5184e844c1372ce9da0a71f373f89b80ff11f120b01678.png">
  <link rel="icon" type="image/png" sizes="16x16" href="http://localhost:4000/assets/favicons/favicon-16x16-789b56195138252cac40cf7f2425b6fcb4e71c3084abc8525781188781b958d3.png">
  <link rel="manifest" href="http://localhost:4000/manifest.json">
  <link rel="shortcut icon" href="http://localhost:4000/assets/favicons/favicon-8e1fdc2a44d6344b9871b3ecf53a803903891f82a602a3f59c65eda40f2b77b0.ico">
  <link rel="alternate" type="application/rss+xml" title="Elixir School" href="https://elixirschool.com/feed.xml" />
  <meta name="msapplication-config" content="http://localhost:4000/assets/favicons/browserconfig-e66282a6754e6899f9a53c6ebfe120749630242b741deb65f364abc297ccbc96.xml">
  <meta name="theme-color" content="#ffffff">

  
  
  <title>Guardian (Basics) &middot; Elixir School</title>
  <!-- CSS -->
  <!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
  <link rel="stylesheet" type="text/css" href="/assets/main-07a5a32c1a26652d2bb0e43b4c7ade37f20599a76cae3c1e871d3af53cff80b2.css">
  <!--[if lte IE 9]><link rel="stylesheet" type="text/css" href="/assets/ie9-0c07c3ea146a3dd5dce4effda97b3718824cab9c30149877c0e445edecfdee60.css"><![endif]-->
  <!--[if lte IE 8]><link rel="stylesheet" type="text/css" href="/assets/ie8-f0c85ce6ad95a6d33929cb969a44f41a5e96ecb22de55f55d0f3c83cfc0012fc.css"><![endif]-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
  <script type="text/javascript">
  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
  analytics.load("C0p07Sw9j7mZnycKDCgPOAyqJR5hhyoQ");
  analytics.page()
  }}();
  </script>
  <script type="text/javascript">
    if ("serviceWorker" in navigator) {
      if (!navigator.serviceWorker.controller) {
        navigator.serviceWorker.register("http://localhost:4000/serviceworker.js", {
          scope: "http://localhost:4000"
        })
        .then(reg => console.log("Service worker has been registered for scope: ", reg.scope))
        .catch(error => console.log("Service worker registration has failed: ", error));
      }
    }  
  </script>
</head>

	<body class="is-loading">
    <script type="text/javascript">
    var $theme = localStorage.getItem('theme');
    if ($theme === 'dark') document.body.classList.add("dark");
    </script>
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Main -->
			<div id="main">
				<div class="inner">
					<!-- Header -->
					<header id="header">
					  <a href="/en/" class="logo"><strong>Elixir School</strong></a>
					  <ul class="icons">
  
  <li><iframe src="https://ghbtns.com/github-btn.html?user=elixirschool&repo=elixirschool&type=star&count=true" height="20" title="GitHub Stars" width="93" style="vertical-align: sub;"></iframe></li>
  <li><a target="_blank" rel="noopener" title="RSS" href="https://elixirschool.com/feed.xml" class="icon fa-rss-square"><span class="label">RSS</span></a></li>
  <li><a target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/en/lessons/libraries/guardian/&title=Guardian (Basics)&summary=description&source=http://localhost:4000" class="icon fa-linkedin"><span class="label">Linkedin</span></a></li>
  <li><a target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/intent/tweet?url=http://localhost:4000/en/lessons/libraries/guardian/&via=elixirschool&text=ElixirSchool: Guardian (Basics)&hashtags=learnelixir%2Celixirlang&" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
  <li><a target="_blank" rel="noopener" title="Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/en/lessons/libraries/guardian/" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
  <li><a target="_blank" rel="noopener" title="Pinterest" href="https://www.pinterest.com/pin/create/link/?url=http://localhost:4000/en/lessons/libraries/guardian/&media=http://localhost:4000/assets/og_image-fad975b316dea5dc361d199bdfaa076006da49a0a3296f799aa7217b4c8b0cbe.jpg&description=ElixirSchool: Guardian (Basics)" class="icon fa-pinterest"><span class="label">Pinterest</span></a></li>
  <li><a target="_blank" rel="noopener" title="VK" href="https://vk.com/share.php?url=http://localhost:4000/en/lessons/libraries/guardian/&title=ElixirSchool: Guardian (Basics)&description=Check out 'Guardian (Basics)' on ElixirSchool" class="icon fa-vk"><span class="label">VK</span></a></li>
  <li><a target="_blank" rel="noopener" title="Email" href="mailto:?to=&subject=ElixirSchool: Guardian (Basics)&body=Check out 'Guardian (Basics)' on ElixirSchool%0D%0A%0D%0Ahttp://localhost:4000/en/lessons/libraries/guardian/" class="icon fa-envelope"><span class="label">Email</span></a></li>
  <li><a title="Print" href="javascript:window.print()" class="icon fa-print"><span class="label">Print</span></a></li>
</ul>

					</header>
					<section id="section-page" class="ltr">
  <header class="main">
    
      <h1>Guardian (Basics)</h1>
    
  </header>
  <div class="content">
    <p><a href="https://github.com/ueberauth/guardian">Guardian</a> is a widely used authentication library based on <a href="https://jwt.io/">JWT</a> (JSON Web Tokens).</p>

<h2>Table of Contents</h2>
<div id="toc"></div>

<h2 id="jwts">JWTs</h2>

<p>A JWT can provide a rich token for authentication.
Where many authentication systems provide access to only a subject identifier for the resource, JWTs provide this along with other information like:</p>

<ul>
  <li>Who issued the token</li>
  <li>Who is the token for</li>
  <li>Which system should use the token</li>
  <li>What time was it issued</li>
  <li>What time does the token expire</li>
</ul>

<p>In addition to these fields Guardian provides some other fields to facilitate additional functionality:</p>

<ul>
  <li>What type is the token</li>
  <li>What permissions does the bearer have</li>
</ul>

<p>These are just the basic fields in a JWT.
You’re free to add any additional information that your application requires.
Just remember to keep it short, as JWT has to fit in the HTTP header.</p>

<p>This richness means that you can pass JWTs around in your system as a fully contained unit of credentials.</p>

<h3 id="where-to-use-them">Where to use them</h3>

<p>JWT tokens can be used to authenticate any part of your application.</p>

<ul>
  <li>Single page applications</li>
  <li>Controllers (via browser session)</li>
  <li>Controllers (via authorization headers - API)</li>
  <li>Phoenix Channels</li>
  <li>Service to Service requests</li>
  <li>Inter-process</li>
  <li>3rd Party access (OAuth)</li>
  <li>Remember me functionality</li>
  <li>Other interfaces - raw TCP, UDP, CLI, etc</li>
</ul>

<p>JWT tokens can be used everywhere in your application where you need to provide verifiable authentication.</p>

<h3 id="do-i-have-to-use-a-database">Do I have to use a database?</h3>

<p>You do not need to track JWT via a database.
You can simply rely on the issued and expiry timestamps for controlling access.
Often you’ll end up using a database to look up your user resource but the JWT itself does not require it.</p>

<p>For example, if you were going to use JWT to authenticate communication on a UDP socket you likely wouldn’t use a database.
Encode all the information you need directly into the token when you issue it.
Once you verify it (check that it’s signed correctly) you’re good to go.</p>

<p>You <em>can</em> however use a database to track JWT.
If you do, you gain the ability to verify that the token is still valid - that is - it has not been revoked.
Or you could use the records in the DB to force a log out of all tokens a for user.
This is made simple in Guardian by using <a href="https://github.com/hassox/guardian_db">GuardianDb</a>.
GuardianDb uses Guardians ‘Hooks’ to perform validation checks, save and delete from the DB.
We’ll cover that later.</p>

<h2 id="setup">Setup</h2>

<p>There are many options for setting up Guardian. We’ll cover them at some point but let’s start with a simple setup.</p>

<h3 id="minimal-setup">Minimal Setup</h3>

<p>To get started there are a handful of things that you’ll need.</p>

<h4 id="configuration">Configuration</h4>

<p><code class="highlighter-rouge">mix.exs</code></p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">application</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="ss">mod:</span> <span class="p">{</span><span class="no">MyApp</span><span class="p">,</span> <span class="p">[]},</span>
    <span class="ss">applications:</span> <span class="p">[</span><span class="ss">:guardian</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
  <span class="p">]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="p">{</span><span class="ss">guardian:</span> <span class="s2">"~&gt; x.x"</span><span class="p">},</span>
    <span class="o">...</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">config/config.ex</code></p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># in each environment config file you should overwrite this if it's external</span>
<span class="n">config</span> <span class="ss">:guardian</span><span class="p">,</span> <span class="no">Guardian</span><span class="p">,</span>
  <span class="ss">issuer:</span> <span class="s2">"MyAppId"</span><span class="p">,</span>
  <span class="ss">secret_key:</span> <span class="no">Mix</span><span class="o">.</span><span class="n">env</span><span class="p">(),</span>
  <span class="ss">serializer:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">GuardianSerializer</span>
</code></pre></div></div>

<p>This is the minimum set of information you need to provide Guardian with to operate.
You shouldn’t encode your secret key directly into your top-level config.
Instead, each environment should have its own key.
It’s common to use the Mix environment for secrets in dev and test.
Staging and production, however, must use strong secrets.
(e.g.
generated with <code class="highlighter-rouge">mix phoenix.gen.secret</code>)</p>

<p><code class="highlighter-rouge">lib/my_app/guardian_serializer.ex</code></p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">GuardianSerializer</span> <span class="k">do</span>
  <span class="nv">@behaviour</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Serializer</span>

  <span class="n">alias</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Repo</span>
  <span class="n">alias</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">User</span>

  <span class="k">def</span> <span class="n">for_token</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="p">%</span><span class="no">User</span><span class="p">{}),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="s2">"User:</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="p">}</span>
  <span class="k">def</span> <span class="n">for_token</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="s2">"Unknown resource type"</span><span class="p">}</span>

  <span class="k">def</span> <span class="n">from_token</span><span class="p">(</span><span class="s2">"User:"</span> <span class="o">&lt;&gt;</span> <span class="n">id</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="no">Repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="n">id</span><span class="p">)}</span>
  <span class="k">def</span> <span class="n">from_token</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="s2">"Unknown resource type"</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>
<p>Your serializer is responsible for finding the resource identified in the <code class="highlighter-rouge">sub</code> (subject) field.
This could be a lookup from a db, an API, or even a simple string.
It’s also responsible for serializing a resource into the <code class="highlighter-rouge">sub</code> field.</p>

<p>That’s it for the minimum configuration.
There’s plenty more you can do if you need to but to get started that’s enough.</p>

<h4 id="application-usage">Application Usage</h4>

<p>Now that we have the configuration in place to use Guardian, we need to integrate it into the application.
Since this is the minimum setup, let’s first consider HTTP requests.</p>

<h2 id="http-requests">HTTP requests</h2>

<p>Guardian provides a number of Plugs to facilitate integration into HTTP requests.
You can learn about Plug in a <a href="../../specifics/plug/">separate lesson</a>.
Guardian doesn’t require Phoenix, but using Phoenix in the following examples will be easiest to demonstrate.</p>

<p>The easiest way to integrate into HTTP is via the router.
Since Guardian’s HTTP integrations are all based on plugs, you can use these anywhere a plug could be used.</p>

<p>The general flow of Guardian plug is:</p>

<ol>
  <li>Find a token in the request (somewhere) and verify it: <code class="highlighter-rouge">Verify*</code> plugs</li>
  <li>Optionally load the resource identified in the token: <code class="highlighter-rouge">LoadResource</code> plug</li>
  <li>Ensure that there is a valid token for the request and refuse access if not: <code class="highlighter-rouge">EnsureAuthenticated</code> plug</li>
</ol>

<p>To meet all the needs of application developers, Guardian implements these phases separately.
To find the token use the <code class="highlighter-rouge">Verify*</code> plugs.</p>

<p>Let’s create some pipelines.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="ss">:maybe_browser_auth</span> <span class="k">do</span>
  <span class="n">plug</span><span class="p">(</span><span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">VerifySession</span><span class="p">)</span>
  <span class="n">plug</span><span class="p">(</span><span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">VerifyHeader</span><span class="p">,</span> <span class="ss">realm:</span> <span class="s2">"Bearer"</span><span class="p">)</span>
  <span class="n">plug</span><span class="p">(</span><span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">LoadResource</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">pipeline</span> <span class="ss">:ensure_authed_access</span> <span class="k">do</span>
  <span class="n">plug</span><span class="p">(</span><span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">EnsureAuthenticated</span><span class="p">,</span> <span class="p">%{</span><span class="s2">"typ"</span> <span class="o">=&gt;</span> <span class="s2">"access"</span><span class="p">,</span> <span class="ss">handler:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">HttpErrorHandler</span><span class="p">})</span>
<span class="k">end</span>
</code></pre></div></div>

<p>These pipelines can be used to compose different authentication requirements.
The first pipeline tries to find a token first in the session and then falls back to a header.
If it finds one, it will load the resource for you.</p>

<p>The second pipeline requires that there is a valid, verified token present and that it is of type “access”.
To use these, add them to your scope.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scope</span> <span class="s2">"/"</span><span class="p">,</span> <span class="no">MyApp</span> <span class="k">do</span>
  <span class="n">pipe_through</span><span class="p">([</span><span class="ss">:browser</span><span class="p">,</span> <span class="ss">:maybe_browser_auth</span><span class="p">])</span>

  <span class="n">get</span><span class="p">(</span><span class="s2">"/login"</span><span class="p">,</span> <span class="no">LoginController</span><span class="p">,</span> <span class="ss">:new</span><span class="p">)</span>
  <span class="n">post</span><span class="p">(</span><span class="s2">"/login"</span><span class="p">,</span> <span class="no">LoginController</span><span class="p">,</span> <span class="ss">:create</span><span class="p">)</span>
  <span class="n">delete</span><span class="p">(</span><span class="s2">"/login"</span><span class="p">,</span> <span class="no">LoginController</span><span class="p">,</span> <span class="ss">:delete</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">scope</span> <span class="s2">"/"</span><span class="p">,</span> <span class="no">MyApp</span> <span class="k">do</span>
  <span class="n">pipe_through</span><span class="p">([</span><span class="ss">:browser</span><span class="p">,</span> <span class="ss">:maybe_browser_auth</span><span class="p">,</span> <span class="ss">:ensure_authed_access</span><span class="p">])</span>

  <span class="n">resource</span><span class="p">(</span><span class="s2">"/protected/things"</span><span class="p">,</span> <span class="no">ProtectedController</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The login routes above will have the authenticated user if there is one.
The second scope ensures that there is a valid token passed for all actions.
You don’t <em>have</em> to put them in pipelines, you could put them in your controllers for super flexible customization but we’re doing a minimal setup.</p>

<p>We’re missing one piece so far.
The error handler we added on the <code class="highlighter-rouge">EnsureAuthenticated</code> plug.
This is a very simple module that responds to</p>

<ul>
  <li><code class="highlighter-rouge">unauthenticated/2</code></li>
  <li><code class="highlighter-rouge">unauthorized/2</code></li>
</ul>

<p>Both these functions receive a Plug.Conn struct and a params map and should handle their respective errors.
You can even use a Phoenix controller!</p>

<h4 id="in-the-controller">In the controller</h4>

<p>Inside the controller, there are a couple of options for how to access the currently logged in user.
Let’s start with the simplest.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">MyController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>
  <span class="kn">use</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Phoenix</span><span class="o">.</span><span class="no">Controller</span>

  <span class="k">def</span> <span class="n">some_action</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">claims</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># do stuff</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>By using the <code class="highlighter-rouge">Guardian.Phoenix.Controller</code> module, your actions will receive two additional arguments that you can pattern match on.
Remember, if you didn’t use <code class="highlighter-rouge">EnsureAuthenticated</code> you may have a nil user and claims.</p>

<p>The other - more flexible/verbose version - is to use plug helpers.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">MyController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>

  <span class="k">def</span> <span class="n">some_action</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">current_resource</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="c1"># No user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="loginlogout">Login/Logout</h4>

<p>Logging in and out of a browser session is very simple.
In your login controller:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">case</span> <span class="n">find_the_user_and_verify_them_from_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="c1"># Use access tokens.</span>
      <span class="c1"># Other tokens can be used, like :refresh etc</span>
      <span class="n">conn</span>
      <span class="o">|&gt;</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">:access</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="n">respond_somehow</span><span class="p">()</span>

    <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">reason</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="no">nil</span>
      <span class="c1"># handle not verifying the user's credentials</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">delete</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">conn</span>
  <span class="o">|&gt;</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">sign_out</span><span class="p">()</span>
  <span class="o">|&gt;</span> <span class="n">respond_somehow</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When using API login, it’s slightly different because there’s no session and you need to provide the raw token back to the client.
For API login you’ll likely use the <code class="highlighter-rouge">Authorization</code> header to provide the token to your application.
This method is useful when you do not intend on using a session.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">case</span> <span class="n">find_the_user_and_verify_them_from_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">jwt</span><span class="p">,</span> <span class="n">_claims</span><span class="p">}</span> <span class="o">=</span> <span class="no">Guardian</span><span class="o">.</span><span class="n">encode_and_sign</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">:access</span><span class="p">)</span>
      <span class="n">conn</span> <span class="o">|&gt;</span> <span class="n">respond_somehow</span><span class="p">(%{</span><span class="ss">token:</span> <span class="n">jwt</span><span class="p">})</span>

    <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">reason</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="c1"># handle not verifying the user's credentials</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">delete</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">jwt</span> <span class="o">=</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">current_token</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
  <span class="no">Guardian</span><span class="o">.</span><span class="n">revoke!</span><span class="p">(</span><span class="n">jwt</span><span class="p">)</span>
  <span class="n">respond_somehow</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The browser session login calls <code class="highlighter-rouge">encode_and_sign</code> under the hood so you can use them the same way.</p>

    
    <blockquote class="edit-lesson">    
      Caught a mistake or want to contribute to the lesson?
      <a href="https://github.com/elixirschool/elixirschool/edit/master/en/lessons/libraries/guardian.md" target="_blank" rel="noopener">
        Edit this page on GitHub!
      </a>
    </blockquote>
  </div>
</section>



<section>

<div class="row">
    
    
    
    <div class="6u 12u$(small)">
        <a class="button special fit" href="/en/lessons/specifics/nerves/" title="Nerves">← Nerves</a>
    </div>
    
    
    
    <div class="6u 12u$(small)">
        <a class="button special fit" href="/en/lessons/libraries/poolboy/" title="Poolboy">Poolboy →</a>
    </div>
    
</div>
</section>




				</div>
			</div>
			<!-- Sidebar -->
  <div id="sidebar">
    <p class="toggle-theme-wrapper"><a rel="noopener" href="#toggle-theme" class="toggle-theme icon fas fa-circle-o" alt="Toggle Theme" title="Toggle Theme"></a></p>

    <div class="inner">
      
<!-- Locales Section -->
<section id="search" class="alt">
  <div id="locales">

      
        
        

        
          <strong title="English">en</strong>
        
      
        
        

        
          <a href="/es/lessons/libraries/guardian/" title="Spanish / Español">es</a>
        
      
        
        

        
          <a href="/gr/lessons/libraries/guardian/" title="Greek">gr</a>
        
      
        
        

        
          <a href="/ja/lessons/libraries/guardian/" title="Japanese / 日本語">ja</a>
        
      
        
        

        
          <a href="/ko/lessons/libraries/guardian/" title="Korean">ko</a>
        
      
        
        

        
          <a href="/pl/lessons/libraries/guardian/" title="Polish">pl</a>
        
      
        
        

        
          <a href="/pt/lessons/libraries/guardian/" title="Portuguese">pt</a>
        
      
        
        

        
          <a href="/ru/lessons/libraries/guardian/" title="Russian / Русский">ru</a>
        
      
        
        

        
          <a href="/vi/lessons/libraries/guardian/" title="Vietnamese">vi</a>
        
      
        
        

        
          <a href="/zh-hans/lessons/libraries/guardian/" title="Chinese">zh-hans</a>
        
      
        
        

        
          <a href="/zh-hant/lessons/libraries/guardian/" title="Traditional Chinese">zh-hant</a>
        
      

  </div>
</section>


      
<!-- Menu -->
<nav id="menu">
  <span class="stack-info otp-version">Elixir 1.10.1 - Erlang/OTP 22.0 [erts-10.5.3]</span>
  <header class="major">
    <h2>Menu</h2>
    <p>The premier destination for learning and mastering Elixir</p>
  </header>
  <ul>
    <li>
      <a href="/en/" class=" up ">Home</a>
    </li>
  
    
    
    
    
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Basics</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/basics/basics/">1. Basics</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/collections/">2. Collections</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/enum/">3. Enum</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/pattern-matching/">4. Pattern Matching</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/control-structures/">5. Control Structures</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/functions/">6. Functions</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/pipe-operator/">7. Pipe Operator</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/modules/">8. Modules</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/mix/">9. Mix</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/sigils/">10. Sigils</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/documentation/">11. Documentation</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/testing/">12. Testing</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/comprehensions/">13. Comprehensions</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/strings/">14. Strings</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/date-time/">15. Date and Time</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/mix-tasks/">16. Custom Mix Tasks</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/iex-helpers/">17. IEx Helpers</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Advanced</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/advanced/erlang/">1. Erlang Interoperability</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/error-handling/">2. Error Handling</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/escripts/">3. Executables</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/concurrency/">4. Concurrency</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-concurrency/">5. OTP Concurrency</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-supervisors/">6. OTP Supervisors</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-distribution/">7. OTP Distribution</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/metaprogramming/">8. Metaprogramming</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/umbrella-projects/">9. Umbrella Projects</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/typespec/">10. Specifications and types</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/behaviours/">11. Behaviours</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/gen-stage/">12. GenStage</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/protocols/">13. Protocols</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Ecto</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/ecto/basics/">1. Basics</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/changesets/">2. Changesets</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/associations/">3. Associations</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/querying/">4. Querying</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Specifics</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/specifics/plug/">1. Plug</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/eex/">2. Embedded Elixir (EEx)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/ets/">3. Erlang Term Storage (ETS)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/mnesia/">4. Mnesia</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/debugging/">5. Debugging</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/nerves/">6. Nerves</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener active up">Libraries</span>
          <ul>
        
            <li>
              
              <span class="active">1. Guardian (Basics)</span>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/poolboy/">2. Poolboy</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/benchee/">3. Benchee</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/bypass/">4. Bypass</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/distillery/">5. Distillery (Basics)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/stream-data/">6. StreamData</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    <li>
      <a href="/blog/" class=" up ">Blog</a>
    </li>
    
    <li>
      <a href="/contributors/" class=" up ">Contributors</a>
    </li>
  </ul>
</nav>

      <!-- Footer -->
      <footer id="footer">
        <p class="copyright">&copy; 2021 <a target="_blank" rel="noopener" href="https://github.com/doomspork">Sean Callan</a> All rights reserved.</p>
      </footer>
    </div>
  </div>

		</div>
		<!-- Scripts -->

    <script async="" src="/assets/main-f8c201d2721dcb6d1d4f6acb0ebd2b2c192757ed29271f519513e4417e347611.js" type="text/javascript"></script>
		<!--[if lte IE 8]><script async="" src="/assets/ie/respond.min-8306093ccce666c01dab405fac0d16596a1d1cf38aa0ba919d4831261662cdbb.js" type="text/javascript"></script><script src="assets/js/ie/respond.min.js"></script><![endif]-->
	</body>
</html>
