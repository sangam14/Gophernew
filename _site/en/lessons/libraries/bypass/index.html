<!DOCTYPE HTML>



<html lang="en">
	<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta name="description" content="The premier destination for learning and mastering Elixir">
  <meta name="author" content="Sean Callan">

  <meta property="og:url" content="http://localhost:4000/en/lessons/libraries/bypass/">
  <meta property="og:site_name" content="ElixirSchool">
  <meta property="og:title" content="Elixir School">
  <meta property="og:locale" content="en">
  <meta property="og:description" content="The premier destination for learning and mastering Elixir">
  <meta property="og:image" content="http://localhost:4000/assets/og_image-fad975b316dea5dc361d199bdfaa076006da49a0a3296f799aa7217b4c8b0cbe.jpg">
  
  
    
    
    
    
      <link rel="alternate" hreflang="en" href="/en/lessons/libraries/bypass/" />
      <link rel="alternate" hreflang="x-default" href="/en/lessons/libraries/bypass/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="es" href="/es/lessons/libraries/bypass/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="pt" href="/pt/lessons/libraries/bypass/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="ru" href="/ru/lessons/libraries/bypass/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="zh-hans" href="/zh-hans/lessons/libraries/bypass/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="zh-hant" href="/zh-hant/lessons/libraries/bypass/" />
    
  

  <link rel="canonical" href="http://localhost:4000/en/lessons/libraries/bypass/">
  <link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/assets/favicons/apple-touch-icon-06ad80501b5734bba0428ca0fc14fcbe45811a144914f7be78cdab3c3ea25458.png">
  <link rel="icon" type="image/png" sizes="32x32" href="http://localhost:4000/assets/favicons/favicon-32x32-6e7b9eca57d29d185a5184e844c1372ce9da0a71f373f89b80ff11f120b01678.png">
  <link rel="icon" type="image/png" sizes="16x16" href="http://localhost:4000/assets/favicons/favicon-16x16-789b56195138252cac40cf7f2425b6fcb4e71c3084abc8525781188781b958d3.png">
  <link rel="manifest" href="http://localhost:4000/manifest.json">
  <link rel="shortcut icon" href="http://localhost:4000/assets/favicons/favicon-8e1fdc2a44d6344b9871b3ecf53a803903891f82a602a3f59c65eda40f2b77b0.ico">
  <link rel="alternate" type="application/rss+xml" title="Elixir School" href="https://elixirschool.com/feed.xml" />
  <meta name="msapplication-config" content="http://localhost:4000/assets/favicons/browserconfig-e66282a6754e6899f9a53c6ebfe120749630242b741deb65f364abc297ccbc96.xml">
  <meta name="theme-color" content="#ffffff">

  
  
  <title>Bypass &middot; Elixir School</title>
  <!-- CSS -->
  <!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
  <link rel="stylesheet" type="text/css" href="/assets/main-07a5a32c1a26652d2bb0e43b4c7ade37f20599a76cae3c1e871d3af53cff80b2.css">
  <!--[if lte IE 9]><link rel="stylesheet" type="text/css" href="/assets/ie9-0c07c3ea146a3dd5dce4effda97b3718824cab9c30149877c0e445edecfdee60.css"><![endif]-->
  <!--[if lte IE 8]><link rel="stylesheet" type="text/css" href="/assets/ie8-f0c85ce6ad95a6d33929cb969a44f41a5e96ecb22de55f55d0f3c83cfc0012fc.css"><![endif]-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
  <script type="text/javascript">
  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
  analytics.load("C0p07Sw9j7mZnycKDCgPOAyqJR5hhyoQ");
  analytics.page()
  }}();
  </script>
  <script type="text/javascript">
    if ("serviceWorker" in navigator) {
      if (!navigator.serviceWorker.controller) {
        navigator.serviceWorker.register("http://localhost:4000/serviceworker.js", {
          scope: "http://localhost:4000"
        })
        .then(reg => console.log("Service worker has been registered for scope: ", reg.scope))
        .catch(error => console.log("Service worker registration has failed: ", error));
      }
    }  
  </script>
</head>

	<body class="is-loading">
    <script type="text/javascript">
    var $theme = localStorage.getItem('theme');
    if ($theme === 'dark') document.body.classList.add("dark");
    </script>
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Main -->
			<div id="main">
				<div class="inner">
					<!-- Header -->
					<header id="header">
					  <a href="/en/" class="logo"><strong>Elixir School</strong></a>
					  <ul class="icons">
  
  <li><iframe src="https://ghbtns.com/github-btn.html?user=elixirschool&repo=elixirschool&type=star&count=true" height="20" title="GitHub Stars" width="93" style="vertical-align: sub;"></iframe></li>
  <li><a target="_blank" rel="noopener" title="RSS" href="https://elixirschool.com/feed.xml" class="icon fa-rss-square"><span class="label">RSS</span></a></li>
  <li><a target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/en/lessons/libraries/bypass/&title=Bypass&summary=description&source=http://localhost:4000" class="icon fa-linkedin"><span class="label">Linkedin</span></a></li>
  <li><a target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/intent/tweet?url=http://localhost:4000/en/lessons/libraries/bypass/&via=elixirschool&text=ElixirSchool: Bypass&hashtags=learnelixir%2Celixirlang&" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
  <li><a target="_blank" rel="noopener" title="Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/en/lessons/libraries/bypass/" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
  <li><a target="_blank" rel="noopener" title="Pinterest" href="https://www.pinterest.com/pin/create/link/?url=http://localhost:4000/en/lessons/libraries/bypass/&media=http://localhost:4000/assets/og_image-fad975b316dea5dc361d199bdfaa076006da49a0a3296f799aa7217b4c8b0cbe.jpg&description=ElixirSchool: Bypass" class="icon fa-pinterest"><span class="label">Pinterest</span></a></li>
  <li><a target="_blank" rel="noopener" title="VK" href="https://vk.com/share.php?url=http://localhost:4000/en/lessons/libraries/bypass/&title=ElixirSchool: Bypass&description=Check out 'Bypass' on ElixirSchool" class="icon fa-vk"><span class="label">VK</span></a></li>
  <li><a target="_blank" rel="noopener" title="Email" href="mailto:?to=&subject=ElixirSchool: Bypass&body=Check out 'Bypass' on ElixirSchool%0D%0A%0D%0Ahttp://localhost:4000/en/lessons/libraries/bypass/" class="icon fa-envelope"><span class="label">Email</span></a></li>
  <li><a title="Print" href="javascript:window.print()" class="icon fa-print"><span class="label">Print</span></a></li>
</ul>

					</header>
					<section id="section-page" class="ltr">
  <header class="main">
    
      <h1>Bypass</h1>
    
  </header>
  <div class="content">
    <p>When testing our applications there are often times we need to make requests to external services.
We may even want to simulate different situations like unexpected server errors.
Handling this in an efficient way doesn’t come easy in Elixir without a little help.</p>

<p>In this lesson we’re going to explore how <a href="https://github.com/PSPDFKit-labs/bypass">bypass</a> can help us quickly and easily handle these requests in our tests.</p>

<h2>Table of Contents</h2>
<div id="toc"></div>

<h2 id="what-is-bypass">What is Bypass?</h2>

<p><a href="https://github.com/PSPDFKit-labs/bypass">Bypass</a> is described as “a quick way to create a custom plug that can be put in place instead of an actual HTTP server to return prebaked responses to client requests.”</p>

<p>What does that mean?
Under-the-hood Bypass is an OTP application that masquerades as an external server listening for and responding to requests.
By responding with pre-defined responses we can test any number of possibilities like unexpected service outages and errors along with the expected scenarios we’ll encounter, all without making a single external request.</p>

<h2 id="using-bypass">Using Bypass</h2>

<p>To better illustrate the features of Bypass we’ll be building a simple utility application to ping a list of domains and ensure they’re online.
To do this we’ll create new supervisor project and a GenServer to check the domains on a configurable interval.
By leveraging Bypass in our tests we’ll be able to verify our application will work in many different outcomes.</p>

<p><em>Note</em>: If you wish to skip ahead to the final code, head over to the Elixir School repo <a href="https://github.com/elixirschool/clinic">Clinic</a> and have a look.</p>

<p>By this point we should be comfortable creating new Mix projects and adding our dependencies so we’ll focus instead of the pieces of code we’ll be testing.
If you do need a quick refresher, refer to the <a href="https://elixirschool.com/en/lessons/basics/mix/#new-projects">New Projects</a> section of our <a href="https://elixirschool.com/en/lessons/basics/mix">Mix</a> lesson.</p>

<p>Let’s start by creating a new module that will handle making the requests to our domains.
With <a href="https://github.com/edgurgel/httpoison">HTTPoison</a> let’s create a function, <code class="highlighter-rouge">ping/1</code>, that takes a URL and returns <code class="highlighter-rouge">{:ok, body}</code> for HTTP 200 requests and <code class="highlighter-rouge">{:error, reason}</code> for all others:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Clinic</span><span class="o">.</span><span class="no">HealthCheck</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">ping</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span> <span class="ow">when</span> <span class="n">is_list</span><span class="p">(</span><span class="n">urls</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ping</span><span class="o">/</span><span class="mi">1</span><span class="p">)</span>

  <span class="k">def</span> <span class="n">ping</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">url</span>
    <span class="o">|&gt;</span> <span class="no">HTTPoison</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="n">response</span><span class="p">()</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">response</span><span class="p">({</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">%{</span><span class="ss">status_code:</span> <span class="mi">200</span><span class="p">,</span> <span class="ss">body:</span> <span class="n">body</span><span class="p">}}),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">body</span><span class="p">}</span>
  <span class="k">defp</span> <span class="n">response</span><span class="p">({</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">%{</span><span class="ss">status_code:</span> <span class="n">status_code</span><span class="p">}}),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="s2">"HTTP Status </span><span class="si">#{</span><span class="n">status_code</span><span class="si">}</span><span class="s2">"</span><span class="p">}</span>
  <span class="k">defp</span> <span class="n">response</span><span class="p">({</span><span class="ss">:error</span><span class="p">,</span> <span class="p">%{</span><span class="ss">reason:</span> <span class="n">reason</span><span class="p">}}),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">reason</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You’ll notice we are <em>not</em> making a GenServer and that’s for good reason:
By separating our functionality (and concerns) from the GenServer, we are able to test our code without the added hurdle of concurrency.</p>

<p>With our code in place we need to start on our tests.
Before we can use Bypass we’ll need to ensure it’s running.
To do that, let’s update <code class="highlighter-rouge">test/test_helper.exs</code> look like this:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ExUnit</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="no">Application</span><span class="o">.</span><span class="n">ensure_all_started</span><span class="p">(</span><span class="ss">:bypass</span><span class="p">)</span>
</code></pre></div></div>

<p>Now that we know Bypass will be running during our tests let’s head over to <code class="highlighter-rouge">test/clinic/health_check_test.exs</code> and finish our setup.
To prepare Bypass for accepting requests we need to open the connect with <code class="highlighter-rouge">Bypass.open/1</code>, which can be done in our test setup callback:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Clinic</span><span class="o">.</span><span class="no">HealthCheckTests</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ExUnit</span><span class="o">.</span><span class="no">Case</span>

  <span class="n">setup</span> <span class="k">do</span>
    <span class="n">bypass</span> <span class="o">=</span> <span class="no">Bypass</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="ss">bypass:</span> <span class="n">bypass</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>For now we’ll rely on Bypass using it’s default port but if we needed to change it (which we’ll be doing in a later section), we can supply <code class="highlighter-rouge">Bypass.open/1</code> with the <code class="highlighter-rouge">:port</code> option and a value like <code class="highlighter-rouge">Bypass.open(port: 1337)</code>.
Now we’re ready to put Bypass to work.
We’ll start with a successful request first:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Clinic</span><span class="o">.</span><span class="no">HealthCheckTests</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ExUnit</span><span class="o">.</span><span class="no">Case</span>

  <span class="n">alias</span> <span class="no">Clinic</span><span class="o">.</span><span class="no">HealthCheck</span>

  <span class="n">setup</span> <span class="k">do</span>
    <span class="n">bypass</span> <span class="o">=</span> <span class="no">Bypass</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="ss">bypass:</span> <span class="n">bypass</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="n">test</span> <span class="s2">"request with HTTP 200 response"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">bypass:</span> <span class="n">bypass</span><span class="p">}</span> <span class="k">do</span>
    <span class="no">Bypass</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">bypass</span><span class="p">,</span> <span class="k">fn</span> <span class="n">conn</span> <span class="o">-&gt;</span>
      <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span><span class="o">.</span><span class="n">resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">"pong"</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="n">assert</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="s2">"pong"</span><span class="p">}</span> <span class="o">=</span> <span class="no">HealthCheck</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="s2">"http://localhost:</span><span class="si">#{</span><span class="n">bypass</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Our test is simple enough and if we run it we’ll see it passes but let’s dig in and see what each portion is doing.
The first thing we see in our test is the <code class="highlighter-rouge">Bypass.expect/2</code> function:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Bypass</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">bypass</span><span class="p">,</span> <span class="k">fn</span> <span class="n">conn</span> <span class="o">-&gt;</span>
  <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span><span class="o">.</span><span class="n">resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">"pong"</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Bypass.expect/2</code> takes our Bypass connection and a single arity function which is expected to modify a connection and return it, this is also an opportunity to make assertions on the request to verify it’s as we expect.
Let’s update our test url to include <code class="highlighter-rouge">/ping</code> and assert both the request path and HTTP method:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test</span> <span class="s2">"request with HTTP 200 response"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">bypass:</span> <span class="n">bypass</span><span class="p">}</span> <span class="k">do</span>
  <span class="no">Bypass</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">bypass</span><span class="p">,</span> <span class="k">fn</span> <span class="n">conn</span> <span class="o">-&gt;</span>
    <span class="n">assert</span> <span class="s2">"GET"</span> <span class="o">==</span> <span class="n">conn</span><span class="o">.</span><span class="n">method</span>
    <span class="n">assert</span> <span class="s2">"/ping"</span> <span class="o">==</span> <span class="n">conn</span><span class="o">.</span><span class="n">request_path</span>
    <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span><span class="o">.</span><span class="n">resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">"pong"</span><span class="p">)</span>
  <span class="k">end</span><span class="p">)</span>

  <span class="n">assert</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="s2">"pong"</span><span class="p">}</span> <span class="o">=</span> <span class="no">HealthCheck</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="s2">"http://localhost:</span><span class="si">#{</span><span class="n">bypass</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">/ping"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The last part of our test we use <code class="highlighter-rouge">HealthCheck.ping/1</code> and assert the response is as expected, but what’s <code class="highlighter-rouge">bypass.port</code> all about?
Bypass is actually listening to a local port and intercepting those requests, we’re using <code class="highlighter-rouge">bypass.port</code> to retrieve the default port since we didn’t provide one in <code class="highlighter-rouge">Bypass.open/1</code>.</p>

<p>Next up is adding test cases for errors.
We can start with a test much like our first with some minor changes: returning 500 as the status code and assert the <code class="highlighter-rouge">{:error, reason}</code> tuple is returned:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test</span> <span class="s2">"request with HTTP 500 response"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">bypass:</span> <span class="n">bypass</span><span class="p">}</span> <span class="k">do</span>
  <span class="no">Bypass</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">bypass</span><span class="p">,</span> <span class="k">fn</span> <span class="n">conn</span> <span class="o">-&gt;</span>
    <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span><span class="o">.</span><span class="n">resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">"Server Error"</span><span class="p">)</span>
  <span class="k">end</span><span class="p">)</span>

  <span class="n">assert</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="s2">"HTTP Status 500"</span><span class="p">}</span> <span class="o">=</span> <span class="no">HealthCheck</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="s2">"http://localhost:</span><span class="si">#{</span><span class="n">bypass</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>There’s nothing special to this test case so let’s move on to the next: unexpected server outages, these are the request we’re most concerned with.
To accomplish this we won’t be using <code class="highlighter-rouge">Bypass.expect/2</code> instead we’re going to rely on <code class="highlighter-rouge">Bypass.down/1</code> to shut down the connection:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test</span> <span class="s2">"request with unexpected outage"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">bypass:</span> <span class="n">bypass</span><span class="p">}</span> <span class="k">do</span>
  <span class="no">Bypass</span><span class="o">.</span><span class="n">down</span><span class="p">(</span><span class="n">bypass</span><span class="p">)</span>

  <span class="n">assert</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:econnrefused</span><span class="p">}</span> <span class="o">=</span> <span class="no">HealthCheck</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="s2">"http://localhost:</span><span class="si">#{</span><span class="n">bypass</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If we run our new tests we’ll see everything passes as expected!
With our <code class="highlighter-rouge">HealthCheck</code> module tested we can move on to testing it together with our GenServer based-scheduler.</p>

<h2 id="multiple-external-hosts">Multiple external hosts</h2>

<p>For our project we’ll keep the scheduler barebones and rely on <code class="highlighter-rouge">Process.send_after/3</code> to power our reoccuring checks, for more on the <code class="highlighter-rouge">Process</code> module take a look at the <a href="https://hexdocs.pm/elixir/Process.html">documentation</a>.
Our scheduler requires three options: the collection of sites, the interval of our checks, and the module that implements <code class="highlighter-rouge">ping/1</code>.
By passing in our module we further decouple our functionality and our GenServer, enabling us to better test each in isolation:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">sites</span> <span class="o">=</span> <span class="no">Keyword</span><span class="o">.</span><span class="n">fetch!</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="ss">:sites</span><span class="p">)</span>
  <span class="n">interval</span> <span class="o">=</span> <span class="no">Keyword</span><span class="o">.</span><span class="n">fetch!</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="ss">:interval</span><span class="p">)</span>
  <span class="n">health_check</span> <span class="o">=</span> <span class="no">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="ss">:health_check</span><span class="p">,</span> <span class="no">HealthCheck</span><span class="p">)</span>

  <span class="no">Process</span><span class="o">.</span><span class="n">send_after</span><span class="p">(</span><span class="n">self</span><span class="p">(),</span> <span class="ss">:check</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>

  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">{</span><span class="n">health_check</span><span class="p">,</span> <span class="n">sites</span><span class="p">}}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now we need to define the <code class="highlighter-rouge">handle_info/2</code> function for the <code class="highlighter-rouge">:check</code> message sent <code class="highlighter-rouge">send_after/2</code>.
To keep things simple we’ll pass our sites to <code class="highlighter-rouge">HealthCheck.ping/1</code> and log our results to either <code class="highlighter-rouge">Logger.info</code> or in the case of errors <code class="highlighter-rouge">Logger.error</code>.
We’ll setup our code in a way that will enable us to improve the reporting capabilities at a later time:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="ss">:check</span><span class="p">,</span> <span class="p">{</span><span class="n">health_check</span><span class="p">,</span> <span class="n">sites</span><span class="p">})</span> <span class="k">do</span>
  <span class="n">sites</span>
  <span class="o">|&gt;</span> <span class="n">health_check</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
  <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">report</span><span class="o">/</span><span class="mi">1</span><span class="p">)</span>

  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="p">{</span><span class="n">health_check</span><span class="p">,</span> <span class="n">sites</span><span class="p">}}</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">report</span><span class="p">({</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">body</span><span class="p">}),</span> <span class="k">do</span><span class="p">:</span> <span class="no">Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="k">defp</span> <span class="n">report</span><span class="p">({</span><span class="ss">:error</span><span class="p">,</span> <span class="n">reason</span><span class="p">})</span> <span class="k">do</span>
  <span class="n">reason</span>
  <span class="o">|&gt;</span> <span class="n">to_string</span><span class="p">()</span>
  <span class="o">|&gt;</span> <span class="no">Logger</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div></div>

<p>As discussed we pass our sites to <code class="highlighter-rouge">HealthCheck.ping/1</code> then iterate the results with <code class="highlighter-rouge">Enum.each/2</code> applying our <code class="highlighter-rouge">report/1</code> function against each.
With these functions in place our scheduler is done and we can focus on testing it.</p>

<p>We won’t focus too much on unit testing the schedulers since that won’t require Bypass, so we can skip to the final code:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Clinic</span><span class="o">.</span><span class="no">SchedulerTest</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ExUnit</span><span class="o">.</span><span class="no">Case</span>

  <span class="kn">import</span> <span class="no">ExUnit</span><span class="o">.</span><span class="no">CaptureLog</span>

  <span class="n">alias</span> <span class="no">Clinic</span><span class="o">.</span><span class="no">Scheduler</span>

  <span class="k">defmodule</span> <span class="no">TestCheck</span> <span class="k">do</span>
    <span class="k">def</span> <span class="n">ping</span><span class="p">(</span><span class="n">_sites</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">[{</span><span class="ss">:ok</span><span class="p">,</span> <span class="s2">"pong"</span><span class="p">},</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="s2">"HTTP Status 404"</span><span class="p">}]</span>
  <span class="k">end</span>

  <span class="n">test</span> <span class="s2">"health checks are run and results logged"</span> <span class="k">do</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="ss">health_check:</span> <span class="no">TestCheck</span><span class="p">,</span> <span class="ss">interval:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">sites:</span> <span class="p">[</span><span class="s2">"http://example.com"</span><span class="p">,</span> <span class="s2">"http://example.org"</span><span class="p">]]</span>

    <span class="n">output</span> <span class="o">=</span>
      <span class="n">capture_log</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span>
        <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">_pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="no">Scheduler</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
        <span class="ss">:timer</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
      <span class="k">end</span><span class="p">)</span>

    <span class="n">assert</span> <span class="n">output</span> <span class="o">=~</span> <span class="s2">"pong"</span>
    <span class="n">assert</span> <span class="n">output</span> <span class="o">=~</span> <span class="s2">"HTTP Status 404"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We rely on a test implementation of our health checks with <code class="highlighter-rouge">TestCheck</code> alongside <code class="highlighter-rouge">CaptureLog.capture_log/1</code> to assert that the appropriate messages are logged.</p>

<p>Now we have working <code class="highlighter-rouge">Scheduler</code> and <code class="highlighter-rouge">HealthCheck</code> modules, let’s write an integration test to verify everything works together.
We’ll need Bypass for this test and we’ll have to handle multiple Bypass requests per test, let’s see how we do that.</p>

<p>Remember the <code class="highlighter-rouge">bypass.port</code> from earlier?  When we need to mimic multiple sites, the <code class="highlighter-rouge">:port</code> option comes in handy.
As you’ve probably guessed, we can create multiple Bypass connections each with a different port, these would simulate independent sites.
We’ll start by reviewing our updated <code class="highlighter-rouge">test/clinic_test.exs</code> file:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">ClinicTest</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ExUnit</span><span class="o">.</span><span class="no">Case</span>

  <span class="kn">import</span> <span class="no">ExUnit</span><span class="o">.</span><span class="no">CaptureLog</span>

  <span class="n">alias</span> <span class="no">Clinic</span><span class="o">.</span><span class="no">Scheduler</span>

  <span class="n">test</span> <span class="s2">"sites are checked and results logged"</span> <span class="k">do</span>
    <span class="n">bypass_one</span> <span class="o">=</span> <span class="no">Bypass</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="ss">port:</span> <span class="mi">1234</span><span class="p">)</span>
    <span class="n">bypass_two</span> <span class="o">=</span> <span class="no">Bypass</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="ss">port:</span> <span class="mi">1337</span><span class="p">)</span>

    <span class="no">Bypass</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">bypass_one</span><span class="p">,</span> <span class="k">fn</span> <span class="n">conn</span> <span class="o">-&gt;</span>
      <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span><span class="o">.</span><span class="n">resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">"Server Error"</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="no">Bypass</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">bypass_two</span><span class="p">,</span> <span class="k">fn</span> <span class="n">conn</span> <span class="o">-&gt;</span>
      <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span><span class="o">.</span><span class="n">resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">"pong"</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="ss">interval:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">sites:</span> <span class="p">[</span><span class="s2">"http://localhost:1234"</span><span class="p">,</span> <span class="s2">"http://localhost:1337"</span><span class="p">]]</span>

    <span class="n">output</span> <span class="o">=</span>
      <span class="n">capture_log</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span>
        <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">_pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="no">Scheduler</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
        <span class="ss">:timer</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
      <span class="k">end</span><span class="p">)</span>

    <span class="n">assert</span> <span class="n">output</span> <span class="o">=~</span> <span class="s2">"[info]  pong"</span>
    <span class="n">assert</span> <span class="n">output</span> <span class="o">=~</span> <span class="s2">"[error] HTTP Status 500"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>There shouldn’t be anything too surprisingly in the above test.
Instead of creating a single Bypass connection in <code class="highlighter-rouge">setup</code>, we’re creating two within our test and specifying their ports as 1234 and 1337.
Next we see our <code class="highlighter-rouge">Bypass.expect/2</code> calls and finally the same code we have in <code class="highlighter-rouge">SchedulerTest</code> to start the scheduler and assert we log the appropriate messages.</p>

<p>That’s it!  We’ve built a utility to keep us informed if there’s any issues with our domains and we’ve learned how to employe Bypass to write better tests with external services.</p>

    
    <blockquote class="edit-lesson">    
      Caught a mistake or want to contribute to the lesson?
      <a href="https://github.com/elixirschool/elixirschool/edit/master/en/lessons/libraries/bypass.md" target="_blank" rel="noopener">
        Edit this page on GitHub!
      </a>
    </blockquote>
  </div>
</section>



<section>

<div class="row">
    
    
    
    <div class="6u 12u$(small)">
        <a class="button special fit" href="/en/lessons/libraries/benchee/" title="Benchee">← Benchee</a>
    </div>
    
    
    
    <div class="6u 12u$(small)">
        <a class="button special fit" href="/en/lessons/libraries/distillery/" title="Distillery (Basics)">Distillery (Basics) →</a>
    </div>
    
</div>
</section>




				</div>
			</div>
			<!-- Sidebar -->
  <div id="sidebar">
    <p class="toggle-theme-wrapper"><a rel="noopener" href="#toggle-theme" class="toggle-theme icon fas fa-circle-o" alt="Toggle Theme" title="Toggle Theme"></a></p>

    <div class="inner">
      
<!-- Locales Section -->
<section id="search" class="alt">
  <div id="locales">

      
        
        

        
          <strong title="English">en</strong>
        
      
        
        

        
          <a href="/es/lessons/libraries/bypass/" title="Spanish / Español">es</a>
        
      
        
        

        
          <a href="/pt/lessons/libraries/bypass/" title="Portuguese">pt</a>
        
      
        
        

        
          <a href="/ru/lessons/libraries/bypass/" title="Russian / Русский">ru</a>
        
      
        
        

        
          <a href="/zh-hans/lessons/libraries/bypass/" title="Chinese">zh-hans</a>
        
      
        
        

        
          <a href="/zh-hant/lessons/libraries/bypass/" title="Traditional Chinese">zh-hant</a>
        
      

  </div>
</section>


      
<!-- Menu -->
<nav id="menu">
  <span class="stack-info otp-version">Elixir 1.10.1 - Erlang/OTP 22.0 [erts-10.5.3]</span>
  <header class="major">
    <h2>Menu</h2>
    <p>The premier destination for learning and mastering Elixir</p>
  </header>
  <ul>
    <li>
      <a href="/en/" class=" up ">Home</a>
    </li>
  
    
    
    
    
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Basics</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/basics/basics/">1. Basics</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/collections/">2. Collections</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/enum/">3. Enum</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/pattern-matching/">4. Pattern Matching</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/control-structures/">5. Control Structures</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/functions/">6. Functions</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/pipe-operator/">7. Pipe Operator</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/modules/">8. Modules</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/mix/">9. Mix</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/sigils/">10. Sigils</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/documentation/">11. Documentation</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/testing/">12. Testing</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/comprehensions/">13. Comprehensions</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/strings/">14. Strings</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/date-time/">15. Date and Time</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/mix-tasks/">16. Custom Mix Tasks</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/iex-helpers/">17. IEx Helpers</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Advanced</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/advanced/erlang/">1. Erlang Interoperability</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/error-handling/">2. Error Handling</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/escripts/">3. Executables</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/concurrency/">4. Concurrency</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-concurrency/">5. OTP Concurrency</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-supervisors/">6. OTP Supervisors</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-distribution/">7. OTP Distribution</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/metaprogramming/">8. Metaprogramming</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/umbrella-projects/">9. Umbrella Projects</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/typespec/">10. Specifications and types</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/behaviours/">11. Behaviours</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/gen-stage/">12. GenStage</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/protocols/">13. Protocols</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Ecto</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/ecto/basics/">1. Basics</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/changesets/">2. Changesets</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/associations/">3. Associations</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/querying/">4. Querying</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Specifics</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/specifics/plug/">1. Plug</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/eex/">2. Embedded Elixir (EEx)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/ets/">3. Erlang Term Storage (ETS)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/mnesia/">4. Mnesia</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/debugging/">5. Debugging</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/nerves/">6. Nerves</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener active up">Libraries</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/libraries/guardian/">1. Guardian (Basics)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/poolboy/">2. Poolboy</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/benchee/">3. Benchee</a>
              
            </li>
        
      
        
            <li>
              
              <span class="active">4. Bypass</span>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/distillery/">5. Distillery (Basics)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/stream-data/">6. StreamData</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    <li>
      <a href="/blog/" class=" up ">Blog</a>
    </li>
    
    <li>
      <a href="/contributors/" class=" up ">Contributors</a>
    </li>
  </ul>
</nav>

      <!-- Footer -->
      <footer id="footer">
        <p class="copyright">&copy; 2021 <a target="_blank" rel="noopener" href="https://github.com/doomspork">Sean Callan</a> All rights reserved.</p>
      </footer>
    </div>
  </div>

		</div>
		<!-- Scripts -->

    <script async="" src="/assets/main-f8c201d2721dcb6d1d4f6acb0ebd2b2c192757ed29271f519513e4417e347611.js" type="text/javascript"></script>
		<!--[if lte IE 8]><script async="" src="/assets/ie/respond.min-8306093ccce666c01dab405fac0d16596a1d1cf38aa0ba919d4831261662cdbb.js" type="text/javascript"></script><script src="assets/js/ie/respond.min.js"></script><![endif]-->
	</body>
</html>
