<!DOCTYPE HTML>



<html lang="en">
	<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta name="description" content="The premier destination for learning and mastering Elixir">
  <meta name="author" content="Sean Callan">

  <meta property="og:url" content="http://localhost:4000/en/lessons/advanced/metaprogramming/">
  <meta property="og:site_name" content="ElixirSchool">
  <meta property="og:title" content="Elixir School">
  <meta property="og:locale" content="en">
  <meta property="og:description" content="The premier destination for learning and mastering Elixir">
  <meta property="og:image" content="http://localhost:4000/assets/og_image-fad975b316dea5dc361d199bdfaa076006da49a0a3296f799aa7217b4c8b0cbe.jpg">
  
  
    
    
    
    
      <link rel="alternate" hreflang="de" href="/de/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="en" href="/en/lessons/advanced/metaprogramming/" />
      <link rel="alternate" hreflang="x-default" href="/en/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="es" href="/es/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="el" href="/gr/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="id" href="/id/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="ja" href="/ja/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="ko" href="/ko/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="pl" href="/pl/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="pt" href="/pt/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="ru" href="/ru/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="vi" href="/vi/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="zh-hans" href="/zh-hans/lessons/advanced/metaprogramming/" />
    
  
    
    
    
    
      <link rel="alternate" hreflang="zh-hant" href="/zh-hant/lessons/advanced/metaprogramming/" />
    
  

  <link rel="canonical" href="http://localhost:4000/en/lessons/advanced/metaprogramming/">
  <link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/assets/favicons/apple-touch-icon-06ad80501b5734bba0428ca0fc14fcbe45811a144914f7be78cdab3c3ea25458.png">
  <link rel="icon" type="image/png" sizes="32x32" href="http://localhost:4000/assets/favicons/favicon-32x32-6e7b9eca57d29d185a5184e844c1372ce9da0a71f373f89b80ff11f120b01678.png">
  <link rel="icon" type="image/png" sizes="16x16" href="http://localhost:4000/assets/favicons/favicon-16x16-789b56195138252cac40cf7f2425b6fcb4e71c3084abc8525781188781b958d3.png">
  <link rel="manifest" href="http://localhost:4000/manifest.json">
  <link rel="shortcut icon" href="http://localhost:4000/assets/favicons/favicon-8e1fdc2a44d6344b9871b3ecf53a803903891f82a602a3f59c65eda40f2b77b0.ico">
  <link rel="alternate" type="application/rss+xml" title="Elixir School" href="https://elixirschool.com/feed.xml" />
  <meta name="msapplication-config" content="http://localhost:4000/assets/favicons/browserconfig-e66282a6754e6899f9a53c6ebfe120749630242b741deb65f364abc297ccbc96.xml">
  <meta name="theme-color" content="#ffffff">

  
  
  <title>Metaprogramming &middot; Elixir School</title>
  <!-- CSS -->
  <!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
  <link rel="stylesheet" type="text/css" href="/assets/main-07a5a32c1a26652d2bb0e43b4c7ade37f20599a76cae3c1e871d3af53cff80b2.css">
  <!--[if lte IE 9]><link rel="stylesheet" type="text/css" href="/assets/ie9-0c07c3ea146a3dd5dce4effda97b3718824cab9c30149877c0e445edecfdee60.css"><![endif]-->
  <!--[if lte IE 8]><link rel="stylesheet" type="text/css" href="/assets/ie8-f0c85ce6ad95a6d33929cb969a44f41a5e96ecb22de55f55d0f3c83cfc0012fc.css"><![endif]-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
  <script type="text/javascript">
  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
  analytics.load("C0p07Sw9j7mZnycKDCgPOAyqJR5hhyoQ");
  analytics.page()
  }}();
  </script>
  <script type="text/javascript">
    if ("serviceWorker" in navigator) {
      if (!navigator.serviceWorker.controller) {
        navigator.serviceWorker.register("http://localhost:4000/serviceworker.js", {
          scope: "http://localhost:4000"
        })
        .then(reg => console.log("Service worker has been registered for scope: ", reg.scope))
        .catch(error => console.log("Service worker registration has failed: ", error));
      }
    }  
  </script>
</head>

	<body class="is-loading">
    <script type="text/javascript">
    var $theme = localStorage.getItem('theme');
    if ($theme === 'dark') document.body.classList.add("dark");
    </script>
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Main -->
			<div id="main">
				<div class="inner">
					<!-- Header -->
					<header id="header">
					  <a href="/en/" class="logo"><strong>Elixir School</strong></a>
					  <ul class="icons">
  
  <li><iframe src="https://ghbtns.com/github-btn.html?user=elixirschool&repo=elixirschool&type=star&count=true" height="20" title="GitHub Stars" width="93" style="vertical-align: sub;"></iframe></li>
  <li><a target="_blank" rel="noopener" title="RSS" href="https://elixirschool.com/feed.xml" class="icon fa-rss-square"><span class="label">RSS</span></a></li>
  <li><a target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/en/lessons/advanced/metaprogramming/&title=Metaprogramming&summary=description&source=http://localhost:4000" class="icon fa-linkedin"><span class="label">Linkedin</span></a></li>
  <li><a target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/intent/tweet?url=http://localhost:4000/en/lessons/advanced/metaprogramming/&via=elixirschool&text=ElixirSchool: Metaprogramming&hashtags=learnelixir%2Celixirlang&" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
  <li><a target="_blank" rel="noopener" title="Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/en/lessons/advanced/metaprogramming/" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
  <li><a target="_blank" rel="noopener" title="Pinterest" href="https://www.pinterest.com/pin/create/link/?url=http://localhost:4000/en/lessons/advanced/metaprogramming/&media=http://localhost:4000/assets/og_image-fad975b316dea5dc361d199bdfaa076006da49a0a3296f799aa7217b4c8b0cbe.jpg&description=ElixirSchool: Metaprogramming" class="icon fa-pinterest"><span class="label">Pinterest</span></a></li>
  <li><a target="_blank" rel="noopener" title="VK" href="https://vk.com/share.php?url=http://localhost:4000/en/lessons/advanced/metaprogramming/&title=ElixirSchool: Metaprogramming&description=Check out 'Metaprogramming' on ElixirSchool" class="icon fa-vk"><span class="label">VK</span></a></li>
  <li><a target="_blank" rel="noopener" title="Email" href="mailto:?to=&subject=ElixirSchool: Metaprogramming&body=Check out 'Metaprogramming' on ElixirSchool%0D%0A%0D%0Ahttp://localhost:4000/en/lessons/advanced/metaprogramming/" class="icon fa-envelope"><span class="label">Email</span></a></li>
  <li><a title="Print" href="javascript:window.print()" class="icon fa-print"><span class="label">Print</span></a></li>
</ul>

					</header>
					<section id="section-page" class="ltr">
  <header class="main">
    
      <h1>Metaprogramming</h1>
    
  </header>
  <div class="content">
    <p>Metaprogramming is the process of using code to write code.
In Elixir this gives us the ability to extend the language to fit our needs and dynamically change the code.
We’ll start by looking at how Elixir is represented under the hood, then how to modify it, and finally we can use this knowledge to extend it.</p>

<p>A word of caution:  Metaprogramming is tricky and should only be used when necessary.
Overuse will almost certainly lead to complex code that is difficult to understand and debug.</p>

<h2>Table of Contents</h2>
<div id="toc"></div>

<h2 id="quote">Quote</h2>

<p>The first step to metaprogramming is understanding how expressions are represented.
In Elixir the abstract syntax tree (AST), the internal representation of our code, is composed of tuples.
These tuples contain three parts: function name, metadata, and function arguments.</p>

<p>In order to see these internal structures, Elixir supplies us with the <code class="highlighter-rouge">quote/2</code> function.
Using <code class="highlighter-rouge">quote/2</code> we can convert Elixir code into its underlying representation:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="mi">42</span>
<span class="mi">42</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="s2">"Hello"</span>
<span class="s2">"Hello"</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="ss">:world</span>
<span class="ss">:world</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span>
<span class="p">{</span><span class="ss">:+</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]}</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="k">if</span> <span class="n">value</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="s2">"True"</span><span class="p">,</span> <span class="k">else</span><span class="p">:</span> <span class="s2">"False"</span>
<span class="p">{</span><span class="ss">:if</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span>
 <span class="p">[{</span><span class="ss">:value</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">},</span> <span class="p">[</span><span class="k">do</span><span class="p">:</span> <span class="s2">"True"</span><span class="p">,</span> <span class="k">else</span><span class="p">:</span> <span class="s2">"False"</span><span class="p">]]}</span>
</code></pre></div></div>

<p>Notice the first three don’t return tuples?  There are five literals that return themselves when quoted:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:atom</span>
<span class="ss">:atom</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="s2">"string"</span>
<span class="s2">"string"</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="mi">1</span> <span class="c1"># All numbers</span>
<span class="mi">1</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="c1"># Lists</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="p">{</span><span class="s2">"hello"</span><span class="p">,</span> <span class="ss">:world</span><span class="p">}</span> <span class="c1"># 2 element tuples</span>
<span class="p">{</span><span class="s2">"hello"</span><span class="p">,</span> <span class="ss">:world</span><span class="p">}</span>
</code></pre></div></div>

<h2 id="unquote">Unquote</h2>

<p>Now that we can retrieve the internal structure of our code, how do we modify it?  To inject new code or values we use <code class="highlighter-rouge">unquote/1</code>.
When we unquote an expression it will be evaluated and injected into the AST.
To demonstrate <code class="highlighter-rouge">unquote/1</code> let’s look at some examples:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="n">denominator</span> <span class="o">=</span> <span class="mi">2</span>
<span class="mi">2</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="n">divide</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span>
<span class="p">{</span><span class="ss">:divide</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="p">{</span><span class="ss">:denominator</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">}]}</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="n">divide</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">denominator</span><span class="p">))</span>
<span class="p">{</span><span class="ss">:divide</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">]}</span>
</code></pre></div></div>

<p>In the first example our variable <code class="highlighter-rouge">denominator</code> is quoted so the resulting AST includes a tuple for accessing the variable.
In the <code class="highlighter-rouge">unquote/1</code> example the resulting code includes the value of <code class="highlighter-rouge">denominator</code> instead.</p>

<h2 id="macros">Macros</h2>

<p>Once we understand <code class="highlighter-rouge">quote/2</code> and <code class="highlighter-rouge">unquote/1</code> we’re ready to dive into macros.
It is important to remember that macros, like all metaprogramming, should be used sparingly.</p>

<p>In the simplest of terms macros are special functions designed to return a quoted expression that will be inserted into our application code.
Imagine the macro being replaced with the quoted expression rather than called like a function.
With macros we have everything necessary to extend Elixir and dynamically add code to our applications.</p>

<p>We begin by defining a macro using <code class="highlighter-rouge">defmacro/2</code> which, like much of Elixir, is itself a macro (let that sink in).
As an example we’ll implement <code class="highlighter-rouge">unless</code> as a macro.
Remember that our macro needs to return a quoted expression:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">OurMacro</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="k">unless</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">block</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">!unquote</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let’s require our module and give our macro a whirl:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="kn">require</span> <span class="no">OurMacro</span>
<span class="no">nil</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">OurMacro</span><span class="o">.</span><span class="k">unless</span> <span class="no">true</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="s2">"Hi"</span>
<span class="no">nil</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">OurMacro</span><span class="o">.</span><span class="k">unless</span> <span class="no">false</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="s2">"Hi"</span>
<span class="s2">"Hi"</span>
</code></pre></div></div>

<p>Because macros replace code in our application, we can control when and what is compiled.
An example of this can be found in the <code class="highlighter-rouge">Logger</code> module.
When logging is disabled no code is injected and the resulting application contains no references or function calls to logging.
This is different from other languages where there is still the overhead of a function call even when the implementation is NOP.</p>

<p>To demonstrate this we’ll make a simple logger that can either be enabled or disabled:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Logger</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="n">log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="no">Application</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="ss">:logger</span><span class="p">,</span> <span class="ss">:enabled</span><span class="p">)</span> <span class="k">do</span>
      <span class="kn">quote</span> <span class="k">do</span>
        <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">"Logged message: </span><span class="si">#{</span><span class="kn">unquote</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
  <span class="kn">require</span> <span class="no">Logger</span>

  <span class="k">def</span> <span class="n">test</span> <span class="k">do</span>
    <span class="no">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"This is a log message"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>With logging enabled our <code class="highlighter-rouge">test</code> function would result in code looking something like this:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">test</span> <span class="k">do</span>
  <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">"Logged message: </span><span class="si">#{</span><span class="s2">"This is a log message"</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If we disable logging the resulting code would be:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">test</span> <span class="k">do</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="debugging">Debugging</h2>

<p>Okay, right now we know how to use <code class="highlighter-rouge">quote/2</code>, <code class="highlighter-rouge">unquote/1</code> and write macros.
But what if you have a huge chunk of quoted code and want to understand it? In this case, you can use <code class="highlighter-rouge">Macro.to_string/2</code>.
Take a look at this example:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="kn">quote</span><span class="p">(</span><span class="k">do</span><span class="p">:</span> <span class="n">foo</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="s2">"foo.bar(1, 2, 3)"</span>
</code></pre></div></div>

<p>And when you want to look at the code generated by macros you can combine them with <code class="highlighter-rouge">Macro.expand/2</code> and <code class="highlighter-rouge">Macro.expand_once/2</code>, these functions expand macros into their given quoted code.
The first may expand it several times, while the latter - only once.
For example, let’s modify <code class="highlighter-rouge">unless</code> example from the previous section:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">OurMacro</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="k">unless</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">block</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">!unquote</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="kn">require</span> <span class="no">OurMacro</span>

<span class="n">quoted</span> <span class="o">=</span>
  <span class="kn">quote</span> <span class="k">do</span>
    <span class="no">OurMacro</span><span class="o">.</span><span class="k">unless</span><span class="p">(</span><span class="no">true</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="s2">"Hi"</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre></div></div>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="n">quoted</span> <span class="o">|&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">expand_once</span><span class="p">(</span><span class="n">__ENV__</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">to_string</span> <span class="o">|&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span>
<span class="k">if</span><span class="p">(</span><span class="n">!true</span><span class="p">)</span> <span class="k">do</span>
  <span class="s2">"Hi"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If we run the same code with <code class="highlighter-rouge">Macro.expand/2</code>, it’s intriguing:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="n">quoted</span> <span class="o">|&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">__ENV__</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">to_string</span> <span class="o">|&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span>
<span class="k">case</span><span class="p">(</span><span class="n">!true</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">x</span> <span class="ow">when</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="no">false</span><span class="p">,</span> <span class="no">nil</span><span class="p">]</span> <span class="o">-&gt;</span>
    <span class="no">nil</span>
  <span class="n">_</span> <span class="o">-&gt;</span>
    <span class="s2">"Hi"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You may recall that we’ve mentioned <code class="highlighter-rouge">if</code> is a macro in Elixir, here we see it expanded into the underlying <code class="highlighter-rouge">case</code> statement.</p>

<h3 id="private-macros">Private Macros</h3>

<p>Though not as common, Elixir does support private macros.
A private macro is defined with <code class="highlighter-rouge">defmacrop</code> and can only be called from the module in which it was defined.
Private macros must be defined before the code that invokes them.</p>

<h3 id="macro-hygiene">Macro Hygiene</h3>

<p>How macros interact with the caller’s context when expanded is known as macro hygiene.
By default macros in Elixir are hygienic and will not conflict with our context:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="n">hygienic</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">require</span> <span class="no">Example</span>
<span class="no">nil</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">42</span>
<span class="mi">42</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">Example</span><span class="o">.</span><span class="n">hygienic</span>
<span class="o">-</span><span class="mi">1</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">val</span>
<span class="mi">42</span>
</code></pre></div></div>

<p>What if we wanted to manipulate the value of <code class="highlighter-rouge">val</code>?  To mark a variable as being unhygienic we can use <code class="highlighter-rouge">var!/2</code>.
Let’s update our example to include another macro utilizing <code class="highlighter-rouge">var!/2</code>:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="n">hygienic</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="k">end</span>

  <span class="k">defmacro</span> <span class="n">unhygienic</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="n">var!</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let’s compare how they interact with our context:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="kn">require</span> <span class="no">Example</span>
<span class="no">nil</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">42</span>
<span class="mi">42</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">Example</span><span class="o">.</span><span class="n">hygienic</span>
<span class="o">-</span><span class="mi">1</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">val</span>
<span class="mi">42</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">Example</span><span class="o">.</span><span class="n">unhygienic</span>
<span class="o">-</span><span class="mi">1</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">val</span>
<span class="o">-</span><span class="mi">1</span>
</code></pre></div></div>

<p>By including <code class="highlighter-rouge">var!/2</code> in our macro we manipulated the value of <code class="highlighter-rouge">val</code> without passing it into our macro.
The use of non-hygienic macros should be kept to a minimum.
By including <code class="highlighter-rouge">var!/2</code> we increase the risk of a variable resolution conflict.</p>

<h3 id="binding">Binding</h3>

<p>We already covered the usefulness of <code class="highlighter-rouge">unquote/1</code>, but there’s another way to inject values into our code: binding.
With variable binding we are able to include multiple variables in our macro and ensure they’re only unquoted once, avoiding accidental revaluations.
To use bound variables we need to pass a keyword list to the <code class="highlighter-rouge">bind_quoted</code> option in <code class="highlighter-rouge">quote/2</code>.</p>

<p>To see the benefit of <code class="highlighter-rouge">bind_quote</code> and to demonstrate the revaluation issue let’s use an example.
We can start by creating a macro that simply outputs the expression twice:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="n">double_puts</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="kn">unquote</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
      <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="kn">unquote</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We’ll try out our new macro by passing it the current system time.
We should expect to see it output twice:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Example</span><span class="o">.</span><span class="n">double_puts</span><span class="p">(</span><span class="ss">:os</span><span class="o">.</span><span class="n">system_time</span><span class="p">)</span>
<span class="mi">1450475941851668000</span>
<span class="mi">1450475941851733000</span>
</code></pre></div></div>

<p>The times are different!  What happened?  Using <code class="highlighter-rouge">unquote/1</code> on the same expression multiple times results in revaluation and that can have unintended consequences.
Let’s update the example to use <code class="highlighter-rouge">bind_quoted</code> and see what we get:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="n">double_puts</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="ss">bind_quoted:</span> <span class="p">[</span><span class="ss">expr:</span> <span class="n">expr</span><span class="p">]</span> <span class="k">do</span>
      <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
      <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">require</span> <span class="no">Example</span>
<span class="no">nil</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">Example</span><span class="o">.</span><span class="n">double_puts</span><span class="p">(</span><span class="ss">:os</span><span class="o">.</span><span class="n">system_time</span><span class="p">)</span>
<span class="mi">1450476083466500000</span>
<span class="mi">1450476083466500000</span>
</code></pre></div></div>

<p>With <code class="highlighter-rouge">bind_quoted</code> we get our expected outcome: the same time printed twice.</p>

<p>Now that we’ve covered <code class="highlighter-rouge">quote/2</code>, <code class="highlighter-rouge">unquote/1</code>, and <code class="highlighter-rouge">defmacro/2</code> we have all the tools necessary to extend Elixir to suit our needs.</p>

    
    <blockquote class="edit-lesson">    
      Caught a mistake or want to contribute to the lesson?
      <a href="https://github.com/elixirschool/elixirschool/edit/master/en/lessons/advanced/metaprogramming.md" target="_blank" rel="noopener">
        Edit this page on GitHub!
      </a>
    </blockquote>
  </div>
</section>



<section>

<div class="row">
    
    
    
    <div class="6u 12u$(small)">
        <a class="button special fit" href="/en/lessons/advanced/otp-distribution/" title="OTP Distribution">← OTP Distribution</a>
    </div>
    
    
    
    <div class="6u 12u$(small)">
        <a class="button special fit" href="/en/lessons/advanced/umbrella-projects/" title="Umbrella Projects">Umbrella Projects →</a>
    </div>
    
</div>
</section>




				</div>
			</div>
			<!-- Sidebar -->
  <div id="sidebar">
    <p class="toggle-theme-wrapper"><a rel="noopener" href="#toggle-theme" class="toggle-theme icon fas fa-circle-o" alt="Toggle Theme" title="Toggle Theme"></a></p>

    <div class="inner">
      
<!-- Locales Section -->
<section id="search" class="alt">
  <div id="locales">

      
        
        

        
          <a href="/de/lessons/advanced/metaprogramming/" title="German">de</a>
        
      
        
        

        
          <strong title="English">en</strong>
        
      
        
        

        
          <a href="/es/lessons/advanced/metaprogramming/" title="Spanish / Español">es</a>
        
      
        
        

        
          <a href="/gr/lessons/advanced/metaprogramming/" title="Greek">gr</a>
        
      
        
        

        
          <a href="/id/lessons/advanced/metaprogramming/" title="Indonesian / Bahasa Indonesia">id</a>
        
      
        
        

        
          <a href="/ja/lessons/advanced/metaprogramming/" title="Japanese / 日本語">ja</a>
        
      
        
        

        
          <a href="/ko/lessons/advanced/metaprogramming/" title="Korean">ko</a>
        
      
        
        

        
          <a href="/pl/lessons/advanced/metaprogramming/" title="Polish">pl</a>
        
      
        
        

        
          <a href="/pt/lessons/advanced/metaprogramming/" title="Portuguese">pt</a>
        
      
        
        

        
          <a href="/ru/lessons/advanced/metaprogramming/" title="Russian / Русский">ru</a>
        
      
        
        

        
          <a href="/vi/lessons/advanced/metaprogramming/" title="Vietnamese">vi</a>
        
      
        
        

        
          <a href="/zh-hans/lessons/advanced/metaprogramming/" title="Chinese">zh-hans</a>
        
      
        
        

        
          <a href="/zh-hant/lessons/advanced/metaprogramming/" title="Traditional Chinese">zh-hant</a>
        
      

  </div>
</section>


      
<!-- Menu -->
<nav id="menu">
  <span class="stack-info otp-version">Elixir 1.10.1 - Erlang/OTP 22.0 [erts-10.5.3]</span>
  <header class="major">
    <h2>Menu</h2>
    <p>The premier destination for learning and mastering Elixir</p>
  </header>
  <ul>
    <li>
      <a href="/en/" class=" up ">Home</a>
    </li>
  
    
    
    
    
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Basics</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/basics/basics/">1. Basics</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/collections/">2. Collections</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/enum/">3. Enum</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/pattern-matching/">4. Pattern Matching</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/control-structures/">5. Control Structures</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/functions/">6. Functions</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/pipe-operator/">7. Pipe Operator</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/modules/">8. Modules</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/mix/">9. Mix</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/sigils/">10. Sigils</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/documentation/">11. Documentation</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/testing/">12. Testing</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/comprehensions/">13. Comprehensions</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/strings/">14. Strings</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/date-time/">15. Date and Time</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/mix-tasks/">16. Custom Mix Tasks</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/iex-helpers/">17. IEx Helpers</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener active up">Advanced</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/advanced/erlang/">1. Erlang Interoperability</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/error-handling/">2. Error Handling</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/escripts/">3. Executables</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/concurrency/">4. Concurrency</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-concurrency/">5. OTP Concurrency</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-supervisors/">6. OTP Supervisors</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-distribution/">7. OTP Distribution</a>
              
            </li>
        
      
        
            <li>
              
              <span class="active">8. Metaprogramming</span>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/umbrella-projects/">9. Umbrella Projects</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/typespec/">10. Specifications and types</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/behaviours/">11. Behaviours</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/gen-stage/">12. GenStage</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/protocols/">13. Protocols</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Ecto</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/ecto/basics/">1. Basics</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/changesets/">2. Changesets</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/associations/">3. Associations</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/querying/">4. Querying</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Specifics</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/specifics/plug/">1. Plug</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/eex/">2. Embedded Elixir (EEx)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/ets/">3. Erlang Term Storage (ETS)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/mnesia/">4. Mnesia</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/debugging/">5. Debugging</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/nerves/">6. Nerves</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Libraries</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/libraries/guardian/">1. Guardian (Basics)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/poolboy/">2. Poolboy</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/benchee/">3. Benchee</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/bypass/">4. Bypass</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/distillery/">5. Distillery (Basics)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/stream-data/">6. StreamData</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    <li>
      <a href="/blog/" class=" up ">Blog</a>
    </li>
    
    <li>
      <a href="/contributors/" class=" up ">Contributors</a>
    </li>
  </ul>
</nav>

      <!-- Footer -->
      <footer id="footer">
        <p class="copyright">&copy; 2021 <a target="_blank" rel="noopener" href="https://github.com/doomspork">Sean Callan</a> All rights reserved.</p>
      </footer>
    </div>
  </div>

		</div>
		<!-- Scripts -->

    <script async="" src="/assets/main-f8c201d2721dcb6d1d4f6acb0ebd2b2c192757ed29271f519513e4417e347611.js" type="text/javascript"></script>
		<!--[if lte IE 8]><script async="" src="/assets/ie/respond.min-8306093ccce666c01dab405fac0d16596a1d1cf38aa0ba919d4831261662cdbb.js" type="text/javascript"></script><script src="assets/js/ie/respond.min.js"></script><![endif]-->
	</body>
</html>
