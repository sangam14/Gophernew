<!DOCTYPE HTML>



<html lang="en">
	<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta name="description" content="">
  <meta name="author" content="Sean Callan">

  <meta property="og:url" content="http://localhost:4000/blog/building-apps-with-plug-router/">
  <meta property="og:site_name" content="ElixirSchool">
  <meta property="og:title" content="">
  <meta property="og:locale" content="">
  <meta property="og:description" content="">
  <meta property="og:image" content="http://localhost:4000/assets/og_image-fad975b316dea5dc361d199bdfaa076006da49a0a3296f799aa7217b4c8b0cbe.jpg">
  
  

  <link rel="canonical" href="http://localhost:4000/blog/building-apps-with-plug-router/">
  <link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/assets/favicons/apple-touch-icon-06ad80501b5734bba0428ca0fc14fcbe45811a144914f7be78cdab3c3ea25458.png">
  <link rel="icon" type="image/png" sizes="32x32" href="http://localhost:4000/assets/favicons/favicon-32x32-6e7b9eca57d29d185a5184e844c1372ce9da0a71f373f89b80ff11f120b01678.png">
  <link rel="icon" type="image/png" sizes="16x16" href="http://localhost:4000/assets/favicons/favicon-16x16-789b56195138252cac40cf7f2425b6fcb4e71c3084abc8525781188781b958d3.png">
  <link rel="manifest" href="http://localhost:4000/manifest.json">
  <link rel="shortcut icon" href="http://localhost:4000/assets/favicons/favicon-8e1fdc2a44d6344b9871b3ecf53a803903891f82a602a3f59c65eda40f2b77b0.ico">
  <link rel="alternate" type="application/rss+xml" title="Elixir School" href="https://elixirschool.com/feed.xml" />
  <meta name="msapplication-config" content="http://localhost:4000/assets/favicons/browserconfig-e66282a6754e6899f9a53c6ebfe120749630242b741deb65f364abc297ccbc96.xml">
  <meta name="theme-color" content="#ffffff">

  
  
  <title>Building web apps with Plug.Router &middot; Elixir School</title>
  <!-- CSS -->
  <!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
  <link rel="stylesheet" type="text/css" href="/assets/main-07a5a32c1a26652d2bb0e43b4c7ade37f20599a76cae3c1e871d3af53cff80b2.css">
  <!--[if lte IE 9]><link rel="stylesheet" type="text/css" href="/assets/ie9-0c07c3ea146a3dd5dce4effda97b3718824cab9c30149877c0e445edecfdee60.css"><![endif]-->
  <!--[if lte IE 8]><link rel="stylesheet" type="text/css" href="/assets/ie8-f0c85ce6ad95a6d33929cb969a44f41a5e96ecb22de55f55d0f3c83cfc0012fc.css"><![endif]-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
  <script type="text/javascript">
  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
  analytics.load("C0p07Sw9j7mZnycKDCgPOAyqJR5hhyoQ");
  analytics.page()
  }}();
  </script>
  <script type="text/javascript">
    if ("serviceWorker" in navigator) {
      if (!navigator.serviceWorker.controller) {
        navigator.serviceWorker.register("http://localhost:4000/serviceworker.js", {
          scope: "http://localhost:4000"
        })
        .then(reg => console.log("Service worker has been registered for scope: ", reg.scope))
        .catch(error => console.log("Service worker registration has failed: ", error));
      }
    }  
  </script>
</head>

	<body class="is-loading">
    <script type="text/javascript">
    var $theme = localStorage.getItem('theme');
    if ($theme === 'dark') document.body.classList.add("dark");
    </script>
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Main -->
			<div id="main">
				<div class="inner">
					<!-- Header -->
					<header id="header">
					  <a href="/" class="logo"><strong>Elixir School</strong> Blog</a>
					  <ul class="icons">
  
  <li><iframe src="https://ghbtns.com/github-btn.html?user=elixirschool&repo=elixirschool&type=star&count=true" height="20" title="GitHub Stars" width="93" style="vertical-align: sub;"></iframe></li>
  <li><a target="_blank" rel="noopener" title="RSS" href="https://elixirschool.com/feed.xml" class="icon fa-rss-square"><span class="label">RSS</span></a></li>
  <li><a target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/blog/building-apps-with-plug-router/&title=Building web apps with Plug.Router&summary=description&source=http://localhost:4000" class="icon fa-linkedin"><span class="label">Linkedin</span></a></li>
  <li><a target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/intent/tweet?url=http://localhost:4000/blog/building-apps-with-plug-router/&via=elixirschool&text=ElixirSchool: Building web apps with Plug.Router&hashtags=learnelixir%2Celixirlang&" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
  <li><a target="_blank" rel="noopener" title="Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/blog/building-apps-with-plug-router/" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
  <li><a target="_blank" rel="noopener" title="Pinterest" href="https://www.pinterest.com/pin/create/link/?url=http://localhost:4000/blog/building-apps-with-plug-router/&media=http://localhost:4000/assets/og_image-fad975b316dea5dc361d199bdfaa076006da49a0a3296f799aa7217b4c8b0cbe.jpg&description=ElixirSchool: Building web apps with Plug.Router" class="icon fa-pinterest"><span class="label">Pinterest</span></a></li>
  <li><a target="_blank" rel="noopener" title="VK" href="https://vk.com/share.php?url=http://localhost:4000/blog/building-apps-with-plug-router/&title=ElixirSchool: Building web apps with Plug.Router&description=Check out 'Building web apps with Plug.Router' on ElixirSchool" class="icon fa-vk"><span class="label">VK</span></a></li>
  <li><a target="_blank" rel="noopener" title="Email" href="mailto:?to=&subject=ElixirSchool: Building web apps with Plug.Router&body=Check out 'Building web apps with Plug.Router' on ElixirSchool%0D%0A%0D%0Ahttp://localhost:4000/blog/building-apps-with-plug-router/" class="icon fa-envelope"><span class="label">Email</span></a></li>
  <li><a title="Print" href="javascript:window.print()" class="icon fa-print"><span class="label">Print</span></a></li>
</ul>

					</header>
					

<section id="section-page">
  <header class="main">
    <h1 class="post-title">Building web apps with Plug.Router</h1>
    <p><a href="/blog/years/2019/">25 Jan 2019</a> · by 

    <a href="https://seancallan.com" target="_blank" rel="nofollow noopener">Sean Callan</a> in <a href="/blog/categories/general/">General</a></p>
  </header>
  <div class="content">
    <p>When it comes to building a web application with Elixir many people will immediately reach for Phoenix.
However, did you know <code class="highlighter-rouge">Plug.Router</code> is just as viable an option?
Sometimes, it can be even faster.</p>

<h2 id="the-project">The project</h2>

<p>For this project we’ll build a simple single page portfolio site.
We can expect our site to load and display our portfolio from a file, database, or somewhere else dynamically. As well as allowing users to submit contact information via a web form.</p>

<p><strong>Please note</strong>: To keep the application and tutorial concise, we will forego database backing and stub this out in favor of concentrating on the web portions.</p>

<p>Want to skip the reading and just look at a code?
Head over to <a href="https://github.com/elixirschool/router_example">elixirschool/router_example</a>.</p>

<h2 id="getting-started">Getting started</h2>

<p>To get started we need to do a couple of things:</p>

<ol>
  <li>Generate a new project with <code class="highlighter-rouge">mix new --sup</code></li>
  <li>Add the <code class="highlighter-rouge">plug_cowboy</code> dependency to <code class="highlighter-rouge">mix.exs</code></li>
  <li>Put our router into the supervision tree of our application</li>
</ol>

<p>Without further delay, let’s get this show on the road and generate our new project:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mix new router_example <span class="nt">--sup</span>

<span class="k">*</span> creating README.md
<span class="k">*</span> creating .formatter.exs
<span class="k">*</span> creating .gitignore
<span class="k">*</span> creating mix.exs
<span class="k">*</span> creating lib
<span class="k">*</span> creating lib/router_example.ex
<span class="k">*</span> creating lib/router_example/application.ex
<span class="k">*</span> creating <span class="nb">test</span>
<span class="k">*</span> creating <span class="nb">test</span>/test_helper.exs
<span class="k">*</span> creating <span class="nb">test</span>/router_example_test.exs

Your Mix project was created successfully.
You can use <span class="s2">"mix"</span> to compile it, <span class="nb">test </span>it, and more:

    <span class="nb">cd </span>router_example
    mix <span class="nb">test

</span>Run <span class="s2">"mix help"</span> <span class="k">for </span>more commands.
</code></pre></div></div>

<p>Let’s head into our new directory and open <code class="highlighter-rouge">mix.exs</code> in the editor of your choice.
Here we’ll make small a small change by adding the <code class="highlighter-rouge">plug_cowboy</code> dependency:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="p">{</span><span class="ss">:plug_cowboy</span><span class="p">,</span> <span class="s2">"~&gt; 2.0"</span><span class="p">}</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>With that change in place we can fetch our dependencies with <code class="highlighter-rouge">mix deps.get</code> and proceed.
Though we have not yet created our router, let’s get the supervisor setup out of the way.
We’ll need to open <code class="highlighter-rouge">lib/router_example/application.ex</code> next so we can update our supervisor’s children.
The <code class="highlighter-rouge">plug_cowboy</code> package makes this step easy with the included <code class="highlighter-rouge">Plug.Cowboy.child_spec/3</code> function.
Let’s update our application’s <code class="highlighter-rouge">start/2</code> function:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">start</span><span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">_args</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">children</span> <span class="o">=</span> <span class="p">[</span>
    <span class="no">Plug</span><span class="o">.</span><span class="no">Cowboy</span><span class="o">.</span><span class="n">child_spec</span><span class="p">(</span><span class="ss">scheme:</span> <span class="ss">:http</span><span class="p">,</span> <span class="ss">plug:</span> <span class="no">RouterExample</span><span class="o">.</span><span class="no">Router</span><span class="p">,</span> <span class="ss">options:</span> <span class="p">[</span><span class="ss">port:</span> <span class="mi">4001</span><span class="p">])</span>
  <span class="p">]</span>

  <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="ss">strategy:</span> <span class="ss">:one_for_one</span><span class="p">,</span> <span class="ss">name:</span> <span class="no">RouterExample</span><span class="o">.</span><span class="no">Supervisor</span><span class="p">]</span>
  <span class="no">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Our setup is complete!
Before we can run our application we’ll need to create our <code class="highlighter-rouge">RouterExample.Router</code> module which we’ll do next.</p>

<h2 id="stubs">Stubs</h2>

<p>As was mentioned in the introduction for the sake of keeping the tutorial short and focused, we’ll be stubbing the functions that would otherwise retrieve data from our datastore and persist it there.
We won’t waste too much time on this file we just need two functions: one to give us a collection of results (stubbing a database lookup) and a second to take our parameters and write them to the terminal (instead of persisting them to a store).</p>

<p>Let’s create a new file <code class="highlighter-rouge">lib/router_example/stubs.ex</code> and copy the following code into it:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">RouterExample</span><span class="o">.</span><span class="no">Stubs</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">portfolio_entries</span> <span class="k">do</span>
    <span class="n">for</span> <span class="n">x</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="p">%{</span><span class="ss">name:</span> <span class="s2">"Project </span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">image:</span> <span class="s2">"https://picsum.photos/400/300/?random?t=</span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">submit_contact</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="ss">label:</span> <span class="s2">"Submitted contact"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><em>Note</em>: If you’re unfamiliar with the <code class="highlighter-rouge">:label</code> option in <code class="highlighter-rouge">IO.inspect/2</code>, check out our other blog post <a href="https://elixirschool.com/blog/til-io-inspect-labels/">TIL IO.inspect labels</a>.</p>

<h2 id="the-router">The Router</h2>

<p>One small line of code, <code class="highlighter-rouge">use Plug.Router</code>, unlocks great potential by bringing the power of <code class="highlighter-rouge">Plug.Router</code> into our application.
Need a refresher on <code class="highlighter-rouge">use/1</code>?
Head on over to Elixir School’s <a href="https://elixirschool.com/en/lessons/basics/modules/#use">section on <code class="highlighter-rouge">use</code></a>.</p>

<p>So what <em>is</em> <code class="highlighter-rouge">Plug.Router</code> afterall?</p>

<p>Stated simply <code class="highlighter-rouge">Plug.Router</code> is a collection of macros that make it easy to match request paths and their type.
If you’re familiar with with Ruby’s <a href="http://sinatrarb.com/">Sinatra</a>, Python’s <a href="http://flask.pocoo.org/">Flask</a>, Java’s <a href="https://jersey.github.io/">Jersey</a>, or any of the other “micro frameworks” then this will look familiar.</p>

<p>Create a new file for our router and open it: <code class="highlighter-rouge">lib/router_example/router.ex</code>.
Let’s copy the basic router code below into our new file and then look at the individual pieces:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">RouterExample</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Router</span>

  <span class="n">plug</span> <span class="ss">:match</span>
  <span class="n">plug</span> <span class="ss">:dispatch</span>

  <span class="n">get</span> <span class="s2">"/ping"</span> <span class="k">do</span>
    <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">"pong"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The first thing we notice after the <code class="highlighter-rouge">use</code> is a series of plugs: <code class="highlighter-rouge">match</code> and <code class="highlighter-rouge">dispatch</code>.
These are included for us and match the incoming request to a function and invoke it respectively.</p>

<p>The next thing we see is our first route!
It’s a simple health check but it’s significant none-the-less, it shows us the format all of our routes will follow: HTTP verb, path, and block of code.
As one migth imagine there is more than <code class="highlighter-rouge">get/1</code>, we also have <code class="highlighter-rouge">post/1</code>, <code class="highlighter-rouge">patch/1</code>, <code class="highlighter-rouge">put/1</code>, <code class="highlighter-rouge">delete/1</code>, <code class="highlighter-rouge">option/1</code>, and <code class="highlighter-rouge">match/1</code>.</p>

<p>In the next few sections we’ll explore some of these other macros but first let’s look at how we can handle rendering EEx templates and JSON.</p>

<p>For more on <code class="highlighter-rouge">Plug.Router</code> check out the dedicated section in our <a href="https://elixirschool.com/en/lessons/specifics/plug/#plugrouter">Plug lesson</a>.</p>

<h3 id="rendering-templates">Rendering templates</h3>

<p>Elixir includes EEx, Embedded Elixir, which lets us parse strings and files and evaluate the embedded Elixir.
For our purposes we’ll focus on <code class="highlighter-rouge">EEx.eval_file/2</code> and use it as the basis for our own <code class="highlighter-rouge">render/3</code> function.</p>

<p>For our <code class="highlighter-rouge">render/3</code> function we’ll pass in our connection struct, a template without the “.eex” extension, and any variable bindings we may want to provide to the embedded Elixir.
We want a function invocation that will look something like this:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">"index.html"</span><span class="p">,</span> <span class="ss">portfolio:</span> <span class="p">[])</span>
</code></pre></div></div>

<p>Now that we know what we want it’s time to build it!</p>

<p>The <code class="highlighter-rouge">EEx.eval_file/2</code> function takes our template’s filepath along with variable bindings and returns the computed string, our response body.
With EEx doing all the heavy lifting our <code class="highlighter-rouge">render/3</code> function needs to do little more than build the complete filepath and send along the response with <code class="highlighter-rouge">send_resp/3</code>:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">@template_dir</span> <span class="s2">"lib/router_example/templates"</span>

<span class="o">...</span>

<span class="k">defp</span> <span class="n">render</span><span class="p">(%{</span><span class="ss">status:</span> <span class="n">status</span><span class="p">}</span> <span class="o">=</span> <span class="n">conn</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">assigns</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
  <span class="n">body</span> <span class="o">=</span>
    <span class="nv">@template_dir</span>
    <span class="o">|&gt;</span> <span class="no">Path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">replace_suffix</span><span class="p">(</span><span class="s2">".html"</span><span class="p">,</span> <span class="s2">".html.eex"</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">EEx</span><span class="o">.</span><span class="n">eval_file</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span>

  <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="mi">200</span><span class="p">),</span> <span class="n">body</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We’ve set it up for EEx to look for our templates in the directory <code class="highlighter-rouge">lib/router_example/templates</code> so let’s create that directory.
Next we’ll create two templates <code class="highlighter-rouge">index.html.eex</code> and <code class="highlighter-rouge">contact.html.eex</code>.</p>

<p>You can find the code for <code class="highlighter-rouge">index.html.eex</code> <a href="https://raw.githubusercontent.com/elixirschool/router_example/master/lib/router_example/templates/index.html.eex">here</a> and <code class="highlighter-rouge">contact.html.eex</code> <a href="https://raw.githubusercontent.com/elixirschool/router_example/master/lib/router_example/templates/contact.html.eex">here</a>, we won’t focus on HTML or CSS today.</p>

<h3 id="sending-and-receiving-json">Sending and receiving JSON</h3>

<p>Building JSON endpoints in Plug.Router is much less work than the template rendering we just covered.</p>

<p>The first thing we need is a library to parse and encode JSON, for our purpose we’ll use <code class="highlighter-rouge">jason</code>:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="ss">:jason</span><span class="p">,</span> <span class="s2">"~&gt; 1.1"</span><span class="p">}</span>
</code></pre></div></div>

<p>Now would be a good time to run <code class="highlighter-rouge">mix deps.get</code> before we forget.
Once we’ve done that we can move on to updating our router to handle incoming JSON via the <code class="highlighter-rouge">Plug.Parsers</code> plug.
Let’s open <code class="highlighter-rouge">lib/router_example/router.ex</code> and update our plugs to include <code class="highlighter-rouge">Plug.Parsers</code> with <code class="highlighter-rouge">Jason</code> as our decoder:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plug</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Parsers</span><span class="p">,</span> <span class="ss">parsers:</span> <span class="p">[</span><span class="ss">:json</span><span class="p">],</span>
                   <span class="ss">pass:</span> <span class="p">[</span><span class="s2">"text/*"</span><span class="p">],</span>
                   <span class="ss">json_decoder:</span> <span class="no">Jason</span>
<span class="n">plug</span> <span class="ss">:match</span>
<span class="n">plug</span> <span class="ss">:dispatch</span>
</code></pre></div></div>

<p>That’s <em>really</em> all we need to do for JSON.</p>

<p>If we want to keep things simple, we can leverage <code class="highlighter-rouge">Jason.encode/1</code> or <code class="highlighter-rouge">Jason.encode!/1</code> along with <code class="highlighter-rouge">send_resp/3</code> and be done:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">json</span><span class="p">}</span> <span class="o">=</span> <span class="no">Jason</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">json</span><span class="p">)</span>
</code></pre></div></div>

<p>Or if we want a little more polish we could make a <code class="highlighter-rouge">render_json/2</code>:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defp</span> <span class="n">render_json</span><span class="p">(%{</span><span class="ss">status:</span> <span class="n">status</span><span class="p">}</span> <span class="o">=</span> <span class="n">conn</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">body</span> <span class="o">=</span> <span class="no">Jason</span><span class="o">.</span><span class="n">encode!</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="mi">200</span><span class="p">),</span> <span class="n">body</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>For the remainder of the post we’ll use the <code class="highlighter-rouge">render_json/2</code> approach.</p>

<p><em>Note</em>: If you intend to use something like the <a href="https://jsonapi.org">JSON:API specification</a>, you may want an additional dependency like <a href="https://github.com/jeregrine/jsonapi">jsonapi</a> to help.</p>

<h3 id="defining-routes">Defining routes</h3>

<p>We now have our router code in place, code to render templates, and code to render JSON, all that’s left is for us to define our routes!</p>

<p>We previously created two EEx templates, <code class="highlighter-rouge">index.html.eex</code> and <code class="highlighter-rouge">contact.html.eex</code>, so we’ll create routes to handle those requests first.
From our healthcheck endpoint we know the format we expect but we can use our new <code class="highlighter-rouge">render/3</code> functions as well as our stubbed data.</p>

<p>If you looked a <code class="highlighter-rouge">index.html.eex</code> then you know our EEx expects a <code class="highlighter-rouge">portfolio</code> capture populated with a list of maps containing <code class="highlighter-rouge">:name</code> and <code class="highlighter-rouge">:image</code>, the format we conveniently defined in our stubbed module!
Let’s bring all the pieces together inside <code class="highlighter-rouge">lib/router_example/router.ex</code>:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get</span> <span class="s2">"/"</span> <span class="k">do</span>
  <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">"index.html"</span><span class="p">,</span> <span class="ss">portfolio:</span> <span class="no">Stubs</span><span class="o">.</span><span class="n">portfolio_entries</span><span class="p">())</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s2">"/contact"</span> <span class="k">do</span>
  <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">"contact.html"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We’re getting there but we’re not <em>quite</em> done.
We have to handle our contact form’s AJAX requests.</p>

<p>In the interest of staying focused we won’t get sidetrack with validation today, instead we’ll make use of our <code class="highlighter-rouge">Stubs.submit_contact/1</code> function.
Let’s create a new route with the <code class="highlighter-rouge">post/1</code> macro that uses the aforementioned function and sends a pleasant JSON message back using our <code class="highlighter-rouge">render_json/2</code> function:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">post</span> <span class="s2">"/contact"</span> <span class="k">do</span>
  <span class="no">Stubs</span><span class="o">.</span><span class="n">submit_contact</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
  <span class="n">render_json</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%{</span><span class="ss">message:</span> <span class="s2">"Thank you! We will get back to you shortly."</span><span class="p">})</span>
<span class="k">end</span>
</code></pre></div></div>

<p>That’s it, we’re done, right?!
Well — we probably want to handle requests to routes we haven’t defined yet.
Let’s do that next and then we can call it done.</p>

<h3 id="missing-routes">Missing routes</h3>

<p>Handling missing routes is a straight forward thanks to Elixir’s powerful pattern matching.
With the <code class="highlighter-rouge">match/3</code> macro and <code class="highlighter-rouge">_</code> we can match on all requests.
By placing this at the bottom of our router we ensure if a request has not previously been matched it will be caught and handled.</p>

<p>For now we’ll implement a simple message, similar to how we implemented our “/ping” endpoint with <code class="highlighter-rouge">send_resp/3</code>:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">RouterExample</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Router</span>

  <span class="o">...</span>

  <span class="n">match</span> <span class="n">_</span> <span class="k">do</span>
    <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">"Oh no! What you seek cannot be found."</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Tada!
Our app is complete, time to wrap things up.</p>

<h3 id="wrapping-things-up">Wrapping things up</h3>

<p>We’ve come a long way in very small lines of code, let’s look the entirety of our app:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">RouterExample</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Router</span>

  <span class="n">alias</span> <span class="no">RouterExample</span><span class="o">.</span><span class="no">Stubs</span>

  <span class="nv">@template_dir</span> <span class="s2">"lib/router_example/templates"</span>

  <span class="n">plug</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Parsers</span><span class="p">,</span> <span class="ss">parsers:</span> <span class="p">[</span><span class="ss">:urlencoded</span><span class="p">,</span> <span class="ss">:json</span><span class="p">],</span>
                   <span class="ss">pass:</span> <span class="p">[</span><span class="s2">"text/*"</span><span class="p">],</span>
                   <span class="ss">json_decoder:</span> <span class="no">Jason</span>
  <span class="n">plug</span> <span class="ss">:match</span>
  <span class="n">plug</span> <span class="ss">:dispatch</span>

  <span class="n">get</span> <span class="s2">"/ping"</span> <span class="k">do</span>
    <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">"pong"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">"/"</span> <span class="k">do</span>
    <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">"index.html"</span><span class="p">,</span> <span class="ss">portfolio:</span> <span class="no">Stubs</span><span class="o">.</span><span class="n">portfolio_entries</span><span class="p">())</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">"/contact"</span> <span class="k">do</span>
    <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">"contact.html"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">post</span> <span class="s2">"/contact"</span> <span class="k">do</span>
    <span class="no">Stubs</span><span class="o">.</span><span class="n">submit_contact</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="n">render_json</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%{</span><span class="ss">message:</span> <span class="s2">"Thank you! We will get back to you shortly."</span><span class="p">})</span>
  <span class="k">end</span>

  <span class="n">match</span> <span class="n">_</span> <span class="k">do</span>
    <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">"Oh no! What you seek cannot be found."</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">render</span><span class="p">(%{</span><span class="ss">status:</span> <span class="n">status</span><span class="p">}</span> <span class="o">=</span> <span class="n">conn</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">assigns</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
    <span class="n">body</span> <span class="o">=</span>
      <span class="nv">@template_dir</span>
      <span class="o">|&gt;</span> <span class="no">Path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">replace_suffix</span><span class="p">(</span><span class="s2">".html"</span><span class="p">,</span> <span class="s2">".html.eex"</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">EEx</span><span class="o">.</span><span class="n">eval_file</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span>

    <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="mi">200</span><span class="p">),</span> <span class="n">body</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">render_json</span><span class="p">(%{</span><span class="ss">status:</span> <span class="n">status</span><span class="p">}</span> <span class="o">=</span> <span class="n">conn</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">body</span> <span class="o">=</span> <span class="no">Jason</span><span class="o">.</span><span class="n">encode!</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="mi">200</span><span class="p">),</span> <span class="n">body</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We’re rendering EEx templates, receiving and sending JSON, and all the <em>entire</em> app (<code class="highlighter-rouge">RouterExample.Router</code> + <code class="highlighter-rouge">RouterExample.Stubs</code>) is 58 lines of code!</p>

<p>All that’s really left for us to do is run it and enjoy our new website.
To run our new app we’ll use <code class="highlighter-rouge">mix run --no-halt</code>, the app can be found at <a href="localhost:4001">localhost:4001</a>.</p>

<p>There is no arguing this is a very basic implementation but it get’s us started.
With these simple pieces we have what we need build to something significant.</p>

<p>We hope you’ve enjoyed!
In future posts we’ll explore improvements like grouping routes together into module, supporting Webpack, other refactors.</p>

<p>The code for our application can be found at <a href="https://github.com/elixirschool/router_example">elixirschool/router_example</a>.</p>

    
    <div class="tags">
      <h4 class="title">Article tags</h4>
      
        <span class="tag"><a href="/blog/tags/plug/">plug</a></span>
      
        <span class="tag"><a href="/blog/tags/software design/">software design</a></span>
      
      </div>
    </p>
    

    <blockquote class="edit-lesson">
      Caught a mistake or want to contribute to the article?
      <a href="https://github.com/elixirschool/elixirschool/edit/master/_posts/2019-01-25-building-apps-with-plug-router.md" target="_blank" rel="noopener">
        Edit this page on GitHub!
      </a>
    </blockquote>
  </div>
</section>
<section class="section-prevnext">
  <div class="row">
    <div class="6u 12u$(small)">
      
        <h4 class="title is-7 has-text-grey-light">Previous article</h4>
        <a class="button special fit" href="http://localhost:4000/blog/recursion/" title="Understanding Recursion with Elixir" rel="prev">&laquo; Understanding Recursion with Elixir</a>
      
    </div>
    <div class="6u 12u$(small)">
      
        <h4>Next article</h4>
        <a class="button special fit" href="http://localhost:4000/blog/til-send-after/" title="TIL about `Process.send_after/4`" rel="next">TIL about `Process.send_after/4` &raquo;</a>
      
    </div>
  </div>
</section>

<section>

    
  
    <div class="row profile">
  <div class="1u 2u(medium) 12u$(small)"><img src="https://github.com/doomspork.png" alt="" style="max-width: 60px;"></div>
  <div class="11u 10u(medium) 12u$(small)">
    <h2>
    
      <a href="https://github.com/doomspork">Sean Callan</a>
    
    </h2>
    <p class="content">Sean has been passionately involved with Elixir since the very beginning. After experiencing the joys of working with Elixir he created Elixir School and has become a core contributor to numerous libraries. During the day, Sean helps companies transition teams and codebases to Elixir.</p>
    <ul class="icons">
      
      <li><a href="https://seancallan.com" class="icon fa-globe"><span class="label">Homepage</span></a></li>
      
      
      <li><a href="https://twitter.com/doomspork" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
      
      <li><a href="https://github.com/doomspork" class="icon fa-github"><span class="label">Github</span></a></li>
    </ul>
  </div>
</div>

  
</section>

				</div>
			</div>
			<!-- Sidebar -->
  <div id="sidebar">
    <p class="toggle-theme-wrapper"><a rel="noopener" href="#toggle-theme" class="toggle-theme icon fas fa-circle-o" alt="Toggle Theme" title="Toggle Theme"></a></p>

    <div class="inner">
      

      
<!-- Menu -->
<nav id="menu">
  <span class="stack-info otp-version">Elixir 1.10.1 - Erlang/OTP 22.0 [erts-10.5.3]</span>
  <header class="major">
    <h2></h2>
    <p>The premier destination for learning and mastering Elixir</p>
  </header>
  <ul>
    <li>
      <a href="/" class=" up ">Home</a>
    </li>
  
    
    
    
    
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Basics</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/basics/basics/">1. Basics</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/collections/">2. Collections</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/enum/">3. Enum</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/pattern-matching/">4. Pattern Matching</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/control-structures/">5. Control Structures</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/functions/">6. Functions</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/pipe-operator/">7. Pipe Operator</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/modules/">8. Modules</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/mix/">9. Mix</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/sigils/">10. Sigils</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/documentation/">11. Documentation</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/testing/">12. Testing</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/comprehensions/">13. Comprehensions</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/strings/">14. Strings</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/date-time/">15. Date and Time</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/mix-tasks/">16. Custom Mix Tasks</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/basics/iex-helpers/">17. IEx Helpers</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Advanced</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/advanced/erlang/">1. Erlang Interoperability</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/error-handling/">2. Error Handling</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/escripts/">3. Executables</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/concurrency/">4. Concurrency</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-concurrency/">5. OTP Concurrency</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-supervisors/">6. OTP Supervisors</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/otp-distribution/">7. OTP Distribution</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/metaprogramming/">8. Metaprogramming</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/umbrella-projects/">9. Umbrella Projects</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/typespec/">10. Specifications and types</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/behaviours/">11. Behaviours</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/gen-stage/">12. GenStage</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/advanced/protocols/">13. Protocols</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Ecto</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/ecto/basics/">1. Basics</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/changesets/">2. Changesets</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/associations/">3. Associations</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/ecto/querying/">4. Querying</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Specifics</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/specifics/plug/">1. Plug</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/eex/">2. Embedded Elixir (EEx)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/ets/">3. Erlang Term Storage (ETS)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/mnesia/">4. Mnesia</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/debugging/">5. Debugging</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/specifics/nerves/">6. Nerves</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    
    
    
    
    
      
        
        <li>
          <span class="opener up">Libraries</span>
          <ul>
        
            <li>
              
              <a href="/en/lessons/libraries/guardian/">1. Guardian (Basics)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/poolboy/">2. Poolboy</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/benchee/">3. Benchee</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/bypass/">4. Bypass</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/distillery/">5. Distillery (Basics)</a>
              
            </li>
        
      
        
            <li>
              
              <a href="/en/lessons/libraries/stream-data/">6. StreamData</a>
              
            </li>
        
          </ul>
        </li>
        
      
    
  
    <li>
      <a href="/blog/" class=" up active">Blog</a>
    </li>
    
    <li>
      <a href="/contributors/" class=" up ">Contributors</a>
    </li>
  </ul>
</nav>

      <!-- Footer -->
      <footer id="footer">
        <p class="copyright">&copy; 2021 <a target="_blank" rel="noopener" href="https://github.com/doomspork">Sean Callan</a> All rights reserved.</p>
      </footer>
    </div>
  </div>

		</div>
		<!-- Scripts -->

    <script async="" src="/assets/main-f8c201d2721dcb6d1d4f6acb0ebd2b2c192757ed29271f519513e4417e347611.js" type="text/javascript"></script>
		<!--[if lte IE 8]><script async="" src="/assets/ie/respond.min-8306093ccce666c01dab405fac0d16596a1d1cf38aa0ba919d4831261662cdbb.js" type="text/javascript"></script><script src="assets/js/ie/respond.min.js"></script><![endif]-->
	</body>
</html>
